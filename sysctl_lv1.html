<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Moderador | Sistema</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }
    .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px; border-bottom: 1px solid var(--border); background: rgba(10,10,15,0.9); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 50; }
    .brand { font-family: 'Cinzel Decorative'; color: var(--accent3); font-size: 1rem; }
    .nav-right { display: flex; align-items: center; gap: 16px; }
    .rol-badge { background: rgba(99,102,241,0.15); border: 1px solid #6366f1; color: #818cf8; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
    .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }
    .logout-btn:hover { color: var(--accent); }
    .container { max-width: 1000px; margin: 0 auto; padding: 28px 20px 80px; }
    .page-title { font-family: 'Cinzel Decorative'; font-size: 1rem; color: var(--text-muted); margin-bottom: 24px; letter-spacing: 2px; }
    .stats-row { display: flex; gap: 16px; margin-bottom: 28px; flex-wrap: wrap; }
    .stat-card { flex: 1; min-width: 140px; background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 18px 20px; }
    .stat-card .num { font-family: 'Cinzel Decorative'; font-size: 1.8rem; color: var(--accent); }
    .stat-card .lbl { color: var(--text-muted); font-size: 0.72rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; margin-top: 4px; }
    .section-title { font-size: 0.72rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: var(--accent3); margin-bottom: 14px; }
    .filtros { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
    .filtro-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); padding: 7px 16px; border-radius: 20px; font-family: 'Rajdhani'; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .filtro-btn.active, .filtro-btn:hover { border-color: var(--accent3); color: var(--accent3); }
    .obra-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    .obra-card:hover { border-color: rgba(99,102,241,0.3); }
    .obra-info h4 { margin: 0 0 4px; color: #fff; font-size: 1rem; }
    .obra-info small { color: var(--text-muted); font-size: 0.75rem; }
    .badge { display: inline-block; font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; text-transform: uppercase; }
    .badge-pendiente { color: #f59e0b; background: rgba(245,158,11,0.12); border: 1px solid #f59e0b; }
    .badge-aprobado  { color: #4CAF50; background: rgba(76,175,80,0.12);  border: 1px solid #4CAF50; }
    .badge-rechazado { color: var(--accent); background: rgba(230,62,109,0.1); border: 1px solid var(--accent); }
    .badge-suspendido { color: #ef4444; background: rgba(239,68,68,0.1); border: 1px solid #ef4444; }
    .btn-accion { background: none; border: 1px solid var(--accent3); color: var(--accent3); padding: 7px 14px; border-radius: 8px; font-family: 'Rajdhani'; font-size: 0.75rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-accion:hover { background: var(--accent3); color: #000; }
    .empty { text-align: center; padding: 50px 20px; color: var(--text-muted); }
    .empty i { font-size: 2rem; display: block; margin-bottom: 12px; opacity: 0.3; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #12121e; border: 1px solid var(--border); border-radius: 20px; padding: 28px; width: 100%; max-width: 480px; }
    .modal-box h3 { font-family: 'Cinzel Decorative'; font-size: 0.9rem; color: #fff; margin-bottom: 8px; }
    .modal-obra { color: var(--accent3); margin-bottom: 20px; font-size: 0.9rem; }
    .modal-box label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; font-weight: 700; }
    .modal-box select, .modal-box textarea { width: 100%; background: #0a0a0f; border: 1px solid var(--border); padding: 12px 14px; border-radius: 10px; color: #fff; font-family: 'Rajdhani'; font-size: 0.95rem; outline: none; transition: 0.2s; box-sizing: border-box; margin-bottom: 16px; }
    .modal-box select:focus, .modal-box textarea:focus { border-color: var(--accent3); }
    .modal-box textarea { resize: vertical; min-height: 80px; }
    .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-cancel-m { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 10px 20px; border-radius: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; }
    .btn-confirm { background: var(--accent3); border: none; color: #000; padding: 10px 24px; border-radius: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; }
    .btn-confirm:hover { filter: brightness(1.1); }
    .modal-err { color: var(--accent); font-size: 0.85rem; margin-bottom: 12px; min-height: 1.2rem; }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <nav class="top-nav">
    <span class="brand">SYSCTL — LV1</span>
    <div class="nav-right">
      <span class="rol-badge">Moderador</span>
      <span id="navNombre" style="color:var(--text-muted);font-size:0.85rem;"></span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>
  </nav>
  <main class="container">
    <p class="page-title">Panel de Moderación</p>
    <div class="stats-row">
      <div class="stat-card"><div class="num" id="statPend">0</div><div class="lbl">Pendientes</div></div>
      <div class="stat-card"><div class="num" id="statAprob">0</div><div class="lbl">Aprobadas</div></div>
      <div class="stat-card"><div class="num" id="statTotal">0</div><div class="lbl">Total Obras</div></div>
    </div>
    <p class="section-title">Obras del Sistema</p>
    <div class="filtros">
      <button class="filtro-btn active" onclick="filtrar('todos',this)">Todas</button>
      <button class="filtro-btn" onclick="filtrar('pendiente',this)">Pendientes</button>
      <button class="filtro-btn" onclick="filtrar('aprobado',this)">Aprobadas</button>
      <button class="filtro-btn" onclick="filtrar('rechazado',this)">Rechazadas</button>
    </div>
    <div id="listaObras"><div class="empty"><i class="fas fa-spinner fa-spin"></i> Cargando...</div></div>
  </main>

  <div class="modal-overlay" id="modalEstado">
    <div class="modal-box">
      <h3>Cambiar Estado</h3>
      <p class="modal-obra" id="modalTitulo"></p>
      <label>Nuevo Estado</label>
      <select id="selectEstado">
        <option value="pendiente">Pendiente</option>
        <option value="aprobado">Aprobado</option>
      </select>
      <label>Motivo (obligatorio)</label>
      <textarea id="motivoEstado" placeholder="Explica el motivo del cambio..."></textarea>
      <div class="modal-err" id="modalErr"></div>
      <div class="modal-btns">
        <button class="btn-cancel-m" onclick="cerrarModal()">Cancelar</button>
        <button class="btn-confirm" onclick="confirmarCambio()">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    const S2 = "https://script.google.com/macros/s/AKfycbyBQSJ0LaCBCEzdIYZkDOaVU8qTP2uivgHGZEmjI10Ew8TQ_75XtnYbJfnCMF_f6i-Bpw/exec";
    const email  = localStorage.getItem("ktt_email") || "";
    const nombre = localStorage.getItem("ktt_user")  || "";
    const rol    = localStorage.getItem("ktt_rol")   || "";

    if (!email || !["moderador","admin","dueno"].includes(rol)) {
      window.location.href = "registrarse.html";
    }
    document.getElementById("navNombre").textContent = nombre;

    let obras = [];
    let filtroActual = "todos";
    let obraId = null;

    async function cargar() {
      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ action:"getObras", emailSolicitante: email }) });
        const data = await res.json();
        if (data.status !== "success") { document.getElementById("listaObras").innerHTML = `<div class="empty"><i class="fas fa-exclamation-triangle"></i> ${data.message}</div>`; return; }
        obras = data.obras || [];
        document.getElementById("statTotal").textContent = obras.length;
        document.getElementById("statPend").textContent  = obras.filter(o => (o.aprobacion||"").toLowerCase() === "pendiente").length;
        document.getElementById("statAprob").textContent = obras.filter(o => (o.aprobacion||"").toLowerCase() === "aprobado").length;
        render();
      } catch(e) {
        document.getElementById("listaObras").innerHTML = `<div class="empty"><i class="fas fa-exclamation-triangle"></i> Error de conexión.</div>`;
      }
    }

    function render() {
      const f = filtroActual === "todos" ? obras : obras.filter(o => (o.aprobacion||"").toLowerCase() === filtroActual);
      if (!f.length) { document.getElementById("listaObras").innerHTML = `<div class="empty"><i class="fas fa-scroll"></i> Sin resultados.</div>`; return; }
      document.getElementById("listaObras").innerHTML = f.map(o => {
        const ap = (o.aprobacion||"pendiente").toLowerCase();
        const bc = ap === "aprobado" ? "badge-aprobado" : ap === "rechazado" ? "badge-rechazado" : ap === "suspendido" ? "badge-suspendido" : "badge-pendiente";
        const tit = o.titulo.replace(/'/g, "\\'");
        return `<div class="obra-card"><div class="obra-info"><h4>${o.titulo}<span class="badge ${bc}">${ap}</span></h4><small>Autor: ${o.autor} · ${o.capitulos||0} caps</small></div><button class="btn-accion" onclick="abrirModal('${o.id}','${tit}')">Cambiar Estado</button></div>`;
      }).join("");
    }

    window.filtrar = (f, btn) => {
      filtroActual = f;
      document.querySelectorAll(".filtro-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      render();
    };

    window.abrirModal = (id, titulo) => {
      obraId = id;
      document.getElementById("modalTitulo").textContent = titulo;
      document.getElementById("motivoEstado").value = "";
      document.getElementById("modalErr").textContent = "";
      document.getElementById("modalEstado").classList.add("open");
    };

    window.cerrarModal = () => { document.getElementById("modalEstado").classList.remove("open"); obraId = null; };

    window.confirmarCambio = async () => {
      const estado = document.getElementById("selectEstado").value;
      const motivo = document.getElementById("motivoEstado").value.trim();
      const errEl  = document.getElementById("modalErr");
      if (!motivo) { errEl.textContent = "El motivo es obligatorio."; return; }
      errEl.textContent = "Guardando...";
      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ action:"cambiarEstadoObra", emailSolicitante: email, idObra: obraId, nuevoEstado: estado, motivo }) });
        const data = await res.json();
        if (data.status === "success") { cerrarModal(); cargar(); }
        else errEl.textContent = data.message || "Error al cambiar estado.";
      } catch(e) { errEl.textContent = "Error de conexión."; }
    };

    window.logout = () => { localStorage.clear(); window.location.href = "registrarse.html"; };
    cargar();
  </script>
</body>
</html>
