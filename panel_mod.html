<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Moderador | Kotatsu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;}

    .top-nav{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 24px;border-bottom:1px solid var(--border);
      background:rgba(10,10,15,0.9);backdrop-filter:blur(12px);
      position:sticky;top:0;z-index:50;
    }
    .brand{font-family:'Cinzel Decorative';color:var(--accent);font-size:1.1rem;}
    .role-tag{
      font-size:0.65rem;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;
      padding:3px 10px;border-radius:20px;border:1px solid #f59e0b;
      color:#f59e0b;background:rgba(245,158,11,0.08);margin-left:10px;
    }
    .logout{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;transition:0.2s;}
    .logout:hover{color:var(--accent);}

    .container{max-width:1000px;margin:0 auto;padding:28px 20px 80px;}

    /* Perfil */
    .profile-card{
      display:flex;align-items:center;gap:20px;
      background:var(--surface);border:1px solid var(--border);
      border-radius:18px;padding:20px 24px;margin-bottom:28px;flex-wrap:wrap;
    }
    .avatar{
      width:72px;height:72px;border-radius:50%;object-fit:cover;
      border:3px solid #f59e0b;background:#1a1a28;flex-shrink:0;
    }
    .profile-info .role-label{color:#f59e0b;font-size:0.65rem;letter-spacing:3px;font-weight:700;text-transform:uppercase;}
    .profile-info h2{color:#fff;margin:4px 0 0;font-size:1.3rem;}

    /* Tabs */
    .panel-tabs{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    .panel-tab{
      flex:1;padding:12px;background:transparent;border:none;
      color:var(--text-muted);font-family:'Rajdhani';font-size:0.8rem;font-weight:700;
      letter-spacing:0.1em;text-transform:uppercase;cursor:pointer;transition:0.2s;
    }
    .panel-tab.active{background:rgba(245,158,11,0.15);color:#f59e0b;border-bottom:2px solid #f59e0b;}

    /* Search */
    .search-mini{
      display:flex;gap:10px;margin-bottom:18px;
    }
    .search-mini input{
      flex:1;background:var(--surface);border:1px solid var(--border);
      padding:10px 14px;border-radius:10px;color:#fff;outline:none;
      font-family:'Rajdhani';font-size:0.95rem;transition:0.2s;
    }
    .search-mini input:focus{border-color:#f59e0b;}

    /* Cards de obras/autores */
    .item-card{
      background:var(--surface);border:1px solid var(--border);
      border-radius:12px;padding:16px 20px;
      display:flex;align-items:center;gap:16px;
      margin-bottom:10px;transition:border-color 0.2s;flex-wrap:wrap;
    }
    .item-card:hover{border-color:rgba(245,158,11,0.3);}

    .item-cover{
      width:48px;height:68px;border-radius:6px;object-fit:cover;
      border:1px solid var(--border);flex-shrink:0;background:var(--surface2);
      display:flex;align-items:center;justify-content:center;font-size:1.2rem;
    }
    .item-info{flex:1;min-width:0;}
    .item-info h4{margin:0 0 4px;color:#fff;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-info small{color:var(--text-muted);font-size:0.75rem;}

    .badge{display:inline-block;font-size:0.62rem;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px;text-transform:uppercase;}
    .badge-aprobado {color:#4CAF50;background:rgba(76,175,80,0.1); border:1px solid #4CAF50;}
    .badge-pendiente{color:#f59e0b;background:rgba(245,158,11,0.1);border:1px solid #f59e0b;}
    .badge-rechazado{color:var(--accent);background:rgba(230,62,109,0.1);border:1px solid var(--accent);}
    .badge-suspension{color:#ff4444;background:rgba(255,68,68,0.1);border:1px solid #ff4444;}
    .badge-activo   {color:#4CAF50;background:rgba(76,175,80,0.1); border:1px solid #4CAF50;}

    .item-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn-action{
      background:none;border:1px solid var(--border);color:var(--text-muted);
      padding:6px 12px;border-radius:8px;cursor:pointer;font-family:'Rajdhani';
      font-size:0.75rem;font-weight:700;transition:0.2s;white-space:nowrap;
    }
    .btn-action.approve{border-color:#4CAF50;color:#4CAF50;}
    .btn-action.approve:hover{background:#4CAF50;color:#000;}
    .btn-action.suspend{border-color:var(--accent);color:var(--accent);}
    .btn-action.suspend:hover{background:var(--accent);color:#fff;}
    .btn-action.review{border-color:#f59e0b;color:#f59e0b;}
    .btn-action.review:hover{background:#f59e0b;color:#000;}

    /* Modal de motivo */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);
      display:flex;align-items:center;justify-content:center;
      z-index:200;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.3s;
    }
    .overlay.open{opacity:1;pointer-events:all;}
    .motivo-box{
      background:#12121e;border:1px solid var(--border);
      border-radius:20px;padding:28px;width:100%;max-width:460px;
      transform:scale(0.95);transition:transform 0.3s;
    }
    .overlay.open .motivo-box{transform:scale(1);}
    .motivo-box h3{font-family:'Cinzel Decorative';color:#f59e0b;margin:0 0 16px;font-size:1rem;}
    .motivo-box textarea{
      width:100%;background:#0a0a0f;border:1px solid var(--border);
      padding:12px;border-radius:10px;color:#fff;font-family:'Rajdhani';
      font-size:0.95rem;resize:vertical;min-height:100px;outline:none;
      transition:0.2s;box-sizing:border-box;
    }
    .motivo-box textarea:focus{border-color:#f59e0b;}
    .motivo-actions{display:flex;gap:10px;margin-top:16px;}
    .btn-modal{
      flex:1;padding:12px;border-radius:10px;border:none;
      font-family:'Rajdhani';font-weight:700;font-size:0.9rem;cursor:pointer;transition:0.2s;
    }
    .btn-modal.cancel{background:var(--surface);color:var(--text-muted);border:1px solid var(--border);}
    .btn-modal.cancel:hover{border-color:var(--accent);color:var(--accent);}
    .btn-modal.confirm{background:linear-gradient(135deg,#f59e0b,#d97706);color:#000;}
    .btn-modal.confirm:hover{filter:brightness(1.1);}

    .empty{text-align:center;padding:50px 20px;color:var(--text-muted);border:1px dashed var(--border);border-radius:12px;}
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav class="top-nav">
    <div style="display:flex;align-items:center;">
      <span class="brand">KOTATSUNAME</span>
      <span class="role-tag"> Moderador</span>
    </div>
    <button class="logout" onclick="cerrarSesion()"><i class="fas fa-power-off"></i></button>
  </nav>

  <main class="container">
    <!-- Perfil -->
    <div class="profile-card">
      <img id="modAvatar" class="avatar"
        src="data:image/svg+xml,<svg viewBox='0 0 1 1' fill='%231a1a28' xmlns='http://www.w3.org/2000/svg'><rect width='1' height='1'/></svg>"
        alt="Avatar" />
      <div class="profile-info">
        <p class="role-label"> Panel de Moderaci贸n</p>
        <h2 id="modName">Moderador</h2>
        <p style="color:var(--text-muted);font-size:0.75rem;" id="modEmail"></p>
      </div>
    </div>

    <!-- Tabs -->
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="switchTab('obras')"> Obras</button>
      <button class="panel-tab" onclick="switchTab('autores')"> Autores</button>
    </div>

    <!-- B煤squeda -->
    <div class="search-mini">
      <input type="text" id="searchBar" placeholder="Buscar por t铆tulo, autor o ID..." oninput="filtrar()" />
    </div>

    <!-- Contenido -->
    <div id="tabContent"></div>
  </main>

  <!-- Modal de motivo -->
  <div class="overlay" id="motivoOverlay">
    <div class="motivo-box">
      <h3 id="motivoTitulo">Ingresa el motivo</h3>
      <textarea id="motivoInput" placeholder="Describe el motivo de esta acci贸n..."></textarea>
      <div class="motivo-actions">
        <button class="btn-modal cancel" onclick="cerrarMotivo()">Cancelar</button>
        <button class="btn-modal confirm" onclick="confirmarAccion()">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireRole, clearSession } from "./staff_auth.js";
    import { loadEscritos } from "./escritos_data.js";

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd3a_Hx34raCWFXyzlLJsCSj1lfg84w79B5PWGoKu6YfRzt92E8giIMZZTl_M3f_FF/exec";

    if (!requireRole(["mod"])) { /* redirigido */ }

    const modName  = localStorage.getItem("ktt_user")  || "Moderador";
    const modEmail = localStorage.getItem("ktt_email") || "";
    const modFoto  = localStorage.getItem("ktt_foto")  || "";

    document.getElementById("modName").textContent  = modName;
    document.getElementById("modEmail").textContent = modEmail;
    if (modFoto) document.getElementById("modAvatar").src = modFoto;

    let allObras   = [];
    let allAutores = [];
    let currentTab = "obras";
    let pendingAction = null; // { type, targetId, targetType }

    window.cerrarSesion = () => { clearSession(); window.location.href = "registrarse.html"; };

    //  Cargar datos 
    async function cargar() {
      allObras = await loadEscritos();
      allAutores = await cargarAutores();
      renderTab();
    }

    async function cargarAutores() {
      try {
        const res  = await fetch(SCRIPT_URL, {
          method:"POST", headers:{"Content-Type":"text/plain"},
          body: JSON.stringify({ action:"getAutores" }),
        });
        const data = await res.json();
        return data.autores || [];
      } catch { return []; }
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      document.querySelectorAll(".panel-tab").forEach((t,i) =>
        t.classList.toggle("active", ["obras","autores"][i] === tab));
      document.getElementById("searchBar").value = "";
      renderTab();
    };

    function renderTab() {
      const q = (document.getElementById("searchBar")?.value || "").toLowerCase();
      const container = document.getElementById("tabContent");

      if (currentTab === "obras") {
        const items = allObras.filter(o =>
          !q || o.titulo.toLowerCase().includes(q) || o.autor.toLowerCase().includes(q) ||
          String(o.id).includes(q)
        );
        if (!items.length) { container.innerHTML = `<div class="empty">No se encontraron obras.</div>`; return; }
        container.innerHTML = items.map(o => {
          const ap = (o.aprobacion || "pendiente").toLowerCase();
          const badgeCls = ap === "aprobado" ? "badge-aprobado" : ap === "rechazado" ? "badge-rechazado" : ap === "suspension" ? "badge-suspension" : "badge-pendiente";
          const coverHtml = o.cover
            ? `<img src="${o.cover}" class="item-cover" alt="${o.titulo}">`
            : `<div class="item-cover"></div>`;
          return `
            <div class="item-card">
              ${coverHtml}
              <div class="item-info">
                <h4>${o.titulo} <span class="badge ${badgeCls}">${ap}</span></h4>
                <small>ID: ${o.id} 路 ${o.autor} 路 ${o.capitulos} caps</small>
              </div>
              <div class="item-actions">
                <button class="btn-action approve" onclick="accion('aprobado','obra','${o.id}')">Aprobar</button>
                <button class="btn-action review"  onclick="accion('revision','obra','${o.id}')">Revisi贸n</button>
                <button class="btn-action suspend" onclick="accion('suspension','obra','${o.id}')">Suspender</button>
              </div>
            </div>`;
        }).join("");
      } else {
        const items = allAutores.filter(a =>
          !q || (a.nombre || "").toLowerCase().includes(q) || String(a.id_autor).includes(q)
        );
        if (!items.length) { container.innerHTML = `<div class="empty">No se encontraron autores.</div>`; return; }
        container.innerHTML = items.map(a => {
          const est = (a.estado || "activo").toLowerCase();
          const badgeCls = est === "suspendido" ? "badge-suspension" : "badge-activo";
          return `
            <div class="item-card">
              <div class="item-info">
                <h4>${a.nombre} <span class="badge ${badgeCls}">${est}</span></h4>
                <small>ID: ${a.id_autor} 路 ${a.email || ""}</small>
              </div>
              <div class="item-actions">
                ${est === "suspendido"
                  ? `<button class="btn-action approve" onclick="accion('activar','autor','${a.id_autor}')">Activar</button>`
                  : `<button class="btn-action suspend" onclick="accion('suspender','autor','${a.id_autor}')">Suspender</button>`
                }
              </div>
            </div>`;
        }).join("");
      }
    }

    window.filtrar = renderTab;

    //  Acciones con motivo 
    window.accion = function(tipo, targetType, targetId) {
      pendingAction = { tipo, targetType, targetId };
      const titles = {
        aprobado:"Aprobar obra", revision:"Marcar en revisi贸n",
        suspension:"Suspender obra", suspender:"Suspender autor", activar:"Activar autor"
      };
      document.getElementById("motivoTitulo").textContent = titles[tipo] || "Acci贸n";
      document.getElementById("motivoInput").value = "";
      document.getElementById("motivoOverlay").classList.add("open");
    };

    window.cerrarMotivo = () => {
      document.getElementById("motivoOverlay").classList.remove("open");
      pendingAction = null;
    };

    window.confirmarAccion = async () => {
      const motivo = document.getElementById("motivoInput").value.trim();
      if (!motivo) { alert("Debes ingresar un motivo."); return; }
      if (!pendingAction) return;

      const { tipo, targetType, targetId } = pendingAction;

      try {
        await fetch(SCRIPT_URL, {
          method:"POST", mode:"no-cors",
          body: JSON.stringify({
            action: targetType === "obra" ? "cambiarAprobacionObra" : "cambiarEstadoAutor",
            idStaff: localStorage.getItem("ktt_id"),
            targetId, nuevoEstado: tipo, motivo,
          }),
        });
        cerrarMotivo();
        setTimeout(() => cargar(), 1000);
      } catch(e) {
        alert("Error de conexi贸n.");
      }
    };

    cargar();
  </script>
</body>
</html>
