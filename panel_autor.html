<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de Autor | Kotatsu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }

    .top-nav {
      display: flex; justify-content: space-between; align-items: center;
      padding: 14px 24px; border-bottom: 1px solid var(--border);
      background: rgba(10,10,15,0.85); backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 50;
    }
    .top-nav .brand  { font-family: 'Cinzel Decorative'; color: var(--accent); font-size: 1.3rem; }
    .top-nav .logout { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1.1rem; transition: color 0.2s; }
    .top-nav .logout:hover { color: var(--accent); }

    .container { max-width: 860px; margin: 0 auto; padding: 28px 20px 80px; }

    .profile-card {
      display: flex; align-items: center; gap: 24px;
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 20px; padding: 24px 28px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3); flex-wrap: wrap;
    }
    .avatar-wrap { position: relative; width: 100px; height: 100px; flex-shrink: 0; }
    .avatar-wrap img {
      width: 100%; height: 100%; border-radius: 50%;
      object-fit: cover; border: 3px solid var(--accent3);
      background: #1a1a28; display: block;
    }
    .avatar-btn {
      position: absolute; bottom: 2px; right: 2px;
      width: 28px; height: 28px; border-radius: 50%;
      background: var(--accent); border: 2px solid var(--surface);
      color: #fff; font-size: 0.7rem; cursor: pointer;
      display: flex; align-items: center; justify-content: center; transition: 0.2s;
    }
    .avatar-btn:hover { transform: scale(1.1); }

    .profile-info .role { color: var(--accent3); font-size: 0.65rem; letter-spacing: 3px; font-weight: 700; text-transform: uppercase; }
    .profile-info h2   { color: #fff; margin: 4px 0 0; font-size: 1.4rem; }
    .profile-info .pid { color: var(--text-muted); font-size: 0.7rem; margin-top: 4px; font-family: monospace; }

    .photo-drawer {
      background: #12121e; border: 1px solid var(--border); border-top: none;
      border-radius: 0 0 20px 20px; max-height: 0; overflow: hidden;
      transition: max-height 0.4s ease, padding 0.3s, opacity 0.3s; opacity: 0;
    }
    .photo-drawer.open { max-height: 160px; padding: 20px 24px; opacity: 1; }
    .photo-drawer label { font-size: 0.7rem; color: var(--text-muted); font-weight: 700; letter-spacing: 2px; text-transform: uppercase; display: block; margin-bottom: 10px; }
    .photo-row { display: flex; gap: 10px; }
    .photo-row input {
      flex: 1; background: #0a0a0f; border: 1px solid var(--border);
      padding: 11px 14px; border-radius: 10px; color: #fff; outline: none;
      font-family: 'Rajdhani'; font-size: 0.95rem; transition: 0.2s;
    }
    .photo-row input:focus { border-color: var(--accent3); }
    .photo-row button {
      background: var(--accent3); color: #000; border: none;
      padding: 0 20px; border-radius: 10px; font-weight: 700;
      font-family: 'Rajdhani'; cursor: pointer; font-size: 0.9rem;
    }

    .obras-header {
      display: flex; justify-content: space-between; align-items: center;
      margin: 28px 0 18px; flex-wrap: wrap; gap: 12px;
    }
    .obras-header h3 { font-family: 'Cinzel Decorative'; font-size: 0.85rem; letter-spacing: 1px; color: var(--text-muted); }
    .btn-nueva {
      background: var(--accent); color: #fff; text-decoration: none;
      padding: 10px 22px; border-radius: 50px; font-weight: 700;
      font-size: 0.75rem; box-shadow: 0 4px 15px rgba(230,62,109,0.3); transition: 0.2s;
    }
    .btn-nueva:hover { filter: brightness(1.1); transform: translateY(-1px); }

    .obra-card {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: 14px; padding: 16px 20px;
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 12px; gap: 16px; transition: border-color 0.2s; flex-wrap: wrap;
    }
    .obra-card:hover { border-color: rgba(230,62,109,0.3); }
    .obra-card h4    { margin: 0 0 4px; color: #fff; font-size: 1rem; }
    .obra-card small { color: var(--text-muted); font-size: 0.75rem; font-weight: 600; }

    .badge { display: inline-block; font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; text-transform: uppercase; }
    .badge-aprobado  { color: #4CAF50; background: rgba(76,175,80,0.12);  border: 1px solid #4CAF50; }
    .badge-pendiente { color: #f59e0b; background: rgba(245,158,11,0.12); border: 1px solid #f59e0b; }
    .badge-rechazado { color: var(--accent); background: rgba(230,62,109,0.1); border: 1px solid var(--accent); }

    .btn-gestionar {
      color: var(--accent3); text-decoration: none; border: 1px solid var(--accent3);
      padding: 7px 14px; border-radius: 8px; font-size: 0.75rem; font-weight: 700;
      white-space: nowrap; transition: 0.2s;
    }
    .btn-gestionar:hover { background: var(--accent3); color: #000; }

    .empty-obras { text-align: center; padding: 50px 20px; border: 1px dashed var(--border); border-radius: 14px; color: var(--text-muted); }
    .empty-obras i { font-size: 2rem; margin-bottom: 12px; display: block; opacity: 0.4; }

    /* Aviso de debug — se muestra si el autor no tiene obras pero hay datos en el sheet */
    .debug-box {
      background: rgba(245,158,11,0.08); border: 1px solid #f59e0b;
      border-radius: 12px; padding: 14px 18px; margin-top: 12px;
      font-size: 0.8rem; color: #f59e0b; display: none;
    }
    .debug-box code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav class="top-nav">
    <span class="brand">KOTATSU</span>
    <button class="logout" id="logoutBtn" title="Cerrar sesión"><i class="fas fa-power-off"></i></button>
  </nav>

  <main class="container">

    <div style="margin-bottom: 20px;">
      <div class="profile-card">
        <div class="avatar-wrap">
          <img id="profileImg"
            src="data:image/svg+xml,<svg viewBox='0 0 1 1' fill='%231a1a28' xmlns='http://www.w3.org/2000/svg'><rect width='1' height='1'/></svg>"
            alt="Avatar" />
          <button class="avatar-btn" onclick="togglePhotoDrawer()" title="Cambiar foto">
            <i class="fas fa-camera"></i>
          </button>
        </div>
        <div class="profile-info">
          <p class="role">Gremio de Escritores</p>
          <h2 id="profileName">Cargando...</h2>
          <!-- Muestra el id del autor para verificar que coincide con el del Sheet -->
          <p class="pid" id="profileId"></p>
        </div>
      </div>

      <div class="photo-drawer" id="photoDrawer">
        <label>Enlace de imagen (Google Drive)</label>
        <div class="photo-row">
          <input type="text" id="driveInput" placeholder="Pega el enlace de compartir de Drive..." />
          <button onclick="guardarFoto()">Actualizar</button>
        </div>
      </div>
    </div>

    <div class="obras-header">
      <h3>Mis Manuscritos</h3>
      <a href="nueva_obra.html" class="btn-nueva">+ Nueva Obra</a>
    </div>

    <div id="listaObras">
      <div style="text-align:center; padding:40px; color:var(--text-muted);">
        <i class="fas fa-spinner fa-spin"></i> &nbsp;Cargando manuscritos...
      </div>
    </div>

    <!-- Solo se muestra si hay obras en el sheet pero ninguna coincide con el autor -->
    <div class="debug-box" id="debugBox">
Parece que aún no tienes ninguna obra publicada o ninguna coincide  on tu id.<br>
      Tu ID: <code id="debugMiId"></code>
    </div>

  </main>

  <script type="module">
    import { loadEscritos } from "./escritos_data.js";

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxZAS5mnuxQ_JlVk_ftcmIA7CUqvfgJqJt9a5QO9OmmCkDo0dW-NXkEdxA37aFtvXmc/exec";

    // Siempre leer como string limpio
    const idAutor = (localStorage.getItem("ktt_id")   || "").trim();
    const user    = (localStorage.getItem("ktt_user") || "").trim();
    const foto    =  localStorage.getItem("ktt_foto") || "";

    if (!idAutor || idAutor === "null" || idAutor === "") {
      window.location.href = "registrarse.html";
    }

    // Mostrar perfil
    document.getElementById("profileName").textContent = user || "Autor";
    document.getElementById("profileId").textContent   = `ID: ${idAutor}`;

    if (foto && foto !== "undefined") {
      document.getElementById("profileImg").src = foto;
    }

    window.togglePhotoDrawer = () => {
      document.getElementById("photoDrawer").classList.toggle("open");
    };

    window.guardarFoto = async () => {
      const val = document.getElementById("driveInput").value.trim();
      if (!val) return;

      const match = val.match(/[-\w]{25,}/);
      if (!match) { alert("Enlace de Drive no válido."); return; }

      const url = `https://wsrv.nl/?url=${encodeURIComponent(
        `https://drive.google.com/uc?export=view&id=${match[0]}`
      )}&w=300&output=webp`;

      document.getElementById("profileImg").src = url;
      localStorage.setItem("ktt_foto", url);
      document.getElementById("photoDrawer").classList.remove("open");
      document.getElementById("driveInput").value = "";

      try {
        await fetch(SCRIPT_URL, {
          method: "POST", mode: "no-cors",
          body: JSON.stringify({ action: "actualizarFoto", idAutor, foto: url }),
        });
      } catch (e) { console.warn("No se pudo sincronizar la foto:", e); }
    };

    async function cargarObras() {
      const container = document.getElementById("listaObras");
      try {
        const todas = await loadEscritos();

        // Filtrar obras cuyo id_autor coincide exactamente con el del autor logueado
        const mias = todas.filter(o => o.id_autor === idAutor);

        if (mias.length === 0) {
          container.innerHTML = `
            <div class="empty-obras">
              <i class="fas fa-scroll"></i>
              Aún no has publicado ningún manuscrito.
            </div>`;

          // Mostrar debug si hay obras en el sheet pero ninguna es mía
          if (todas.length > 0) {
            const todosIds = [...new Set(todas.map(o => o.id_autor))].join(", ");
            document.getElementById("debugBox").style.display = "block";
            document.getElementById("debugMiId").textContent  = idAutor;
            document.getElementById("debugIds").textContent   = todosIds || "(vacíos)";
          }
          return;
        }

        // Ocultar debug si hay obras
        document.getElementById("debugBox").style.display = "none";

        container.innerHTML = mias.map(o => {
          const ap = (o.aprobacion || "pendiente").trim().toLowerCase();
          const badgeClass = ap === "aprobado"  ? "badge-aprobado"
                           : ap === "rechazado" ? "badge-rechazado"
                           : "badge-pendiente";
          const badgeText  = ap === "aprobado"  ? "Publicada"
                           : ap === "rechazado" ? "Rechazada"
                           : "Pendiente";
          return `
            <div class="obra-card">
              <div>
                <h4>${o.titulo}<span class="badge ${badgeClass}">${badgeText}</span></h4>
                <small>
                  ${o.capitulos} CAPÍTULO${o.capitulos !== 1 ? "S" : ""}
                  · ${(o.estado || "").toUpperCase()}
                </small>
              </div>
              <a href="gestion_capitulos.html?id=${o.id}" class="btn-gestionar">Gestionar</a>
            </div>`;
        }).join("");

      } catch (e) {
        console.error(e);
        container.innerHTML = `<p style="color:var(--accent3);text-align:center;">Vaya, se han perdido tus pergaminos.</p>`;
      }
    }

    // Si venimos de crear/editar una obra, esperar un poco antes de cargar
    // para que el Sheet haya procesado el cambio
    if (sessionStorage.getItem("panel_reload") === "1") {
      sessionStorage.removeItem("panel_reload");
      setTimeout(cargarObras, 2000);
    } else {
      cargarObras();
    }

    document.getElementById("logoutBtn").onclick = () => {
      localStorage.clear();
      sessionStorage.clear();
      window.location.href = "registrarse.html";
    };
  </script>
</body>
</html>
