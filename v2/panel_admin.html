<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Administrador | Kotatsu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;}

    .top-nav{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 24px;border-bottom:1px solid var(--border);
      background:rgba(10,10,15,0.9);backdrop-filter:blur(12px);
      position:sticky;top:0;z-index:50;
    }
    .brand{font-family:'Cinzel Decorative';color:var(--accent);font-size:1.1rem;}
    .role-tag{
      font-size:0.65rem;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;
      padding:3px 10px;border-radius:20px;border:1px solid var(--accent3);
      color:var(--accent3);background:rgba(6,182,212,0.08);margin-left:10px;
    }
    .logout{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;transition:0.2s;}
    .logout:hover{color:var(--accent);}

    .container{max-width:1000px;margin:0 auto;padding:28px 20px 80px;}

    .profile-card{
      display:flex;align-items:center;gap:20px;
      background:var(--surface);border:1px solid var(--border);
      border-radius:18px;padding:20px 24px;margin-bottom:28px;flex-wrap:wrap;
    }
    .avatar{width:72px;height:72px;border-radius:50%;object-fit:cover;border:3px solid var(--accent3);background:#1a1a28;flex-shrink:0;}
    .profile-info .role-label{color:var(--accent3);font-size:0.65rem;letter-spacing:3px;font-weight:700;text-transform:uppercase;}
    .profile-info h2{color:#fff;margin:4px 0 0;font-size:1.3rem;}

    .panel-tabs{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--border);border-radius:12px;overflow:hidden;}
    .panel-tab{
      flex:1;padding:12px;background:transparent;border:none;
      color:var(--text-muted);font-family:'Rajdhani';font-size:0.75rem;font-weight:700;
      letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:0.2s;
    }
    .panel-tab.active{background:rgba(6,182,212,0.12);color:var(--accent3);border-bottom:2px solid var(--accent3);}

    .search-mini{display:flex;gap:10px;margin-bottom:18px;}
    .search-mini input{
      flex:1;background:var(--surface);border:1px solid var(--border);
      padding:10px 14px;border-radius:10px;color:#fff;outline:none;
      font-family:'Rajdhani';font-size:0.95rem;transition:0.2s;
    }
    .search-mini input:focus{border-color:var(--accent3);}

    .item-card{
      background:var(--surface);border:1px solid var(--border);
      border-radius:12px;padding:16px 20px;
      display:flex;align-items:center;gap:16px;
      margin-bottom:10px;transition:border-color 0.2s;flex-wrap:wrap;
    }
    .item-card:hover{border-color:rgba(6,182,212,0.3);}

    .item-cover{
      width:48px;height:68px;border-radius:6px;object-fit:cover;
      border:1px solid var(--border);flex-shrink:0;background:var(--surface2);
      display:flex;align-items:center;justify-content:center;font-size:1.2rem;
    }
    .item-info{flex:1;min-width:0;}
    .item-info h4{margin:0 0 4px;color:#fff;font-size:0.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-info small{color:var(--text-muted);font-size:0.75rem;}

    .badge{display:inline-block;font-size:0.62rem;font-weight:700;padding:2px 8px;border-radius:10px;margin-left:6px;text-transform:uppercase;}
    .badge-aprobado {color:#4CAF50;background:rgba(76,175,80,0.1); border:1px solid #4CAF50;}
    .badge-pendiente{color:#f59e0b;background:rgba(245,158,11,0.1);border:1px solid #f59e0b;}
    .badge-rechazado,.badge-suspension{color:var(--accent);background:rgba(230,62,109,0.1);border:1px solid var(--accent);}
    .badge-activo   {color:#4CAF50;background:rgba(76,175,80,0.1); border:1px solid #4CAF50;}
    .badge-mod      {color:#f59e0b;background:rgba(245,158,11,0.08);border:1px solid #f59e0b;}

    .item-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .btn-action{
      background:none;border:1px solid var(--border);color:var(--text-muted);
      padding:6px 12px;border-radius:8px;cursor:pointer;font-family:'Rajdhani';
      font-size:0.75rem;font-weight:700;transition:0.2s;white-space:nowrap;
    }
    .btn-action.approve{border-color:#4CAF50;color:#4CAF50;}
    .btn-action.approve:hover{background:#4CAF50;color:#000;}
    .btn-action.suspend{border-color:var(--accent);color:var(--accent);}
    .btn-action.suspend:hover{background:var(--accent);color:#fff;}
    .btn-action.review{border-color:#f59e0b;color:#f59e0b;}
    .btn-action.review:hover{background:#f59e0b;color:#000;}
    .btn-action.create-mod{border-color:var(--accent3);color:var(--accent3);}
    .btn-action.create-mod:hover{background:var(--accent3);color:#000;}

    /* Modal */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.8);
      display:flex;align-items:center;justify-content:center;
      z-index:200;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.3s;
    }
    .overlay.open{opacity:1;pointer-events:all;}
    .modal-box{
      background:#12121e;border:1px solid var(--border);
      border-radius:20px;padding:28px;width:100%;max-width:480px;
      transform:scale(0.95);transition:transform 0.3s;
    }
    .overlay.open .modal-box{transform:scale(1);}
    .modal-box h3{font-family:'Cinzel Decorative';color:var(--accent3);margin:0 0 18px;font-size:1rem;}
    .field{margin-bottom:14px;}
    .field label{display:block;font-size:0.68rem;color:var(--text-muted);font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
    .field input,.field textarea{
      width:100%;background:#0a0a0f;border:1px solid var(--border);
      padding:11px 13px;border-radius:10px;color:#fff;font-family:'Rajdhani';
      font-size:0.95rem;outline:none;transition:0.2s;box-sizing:border-box;
    }
    .field input:focus,.field textarea:focus{border-color:var(--accent3);}
    .field textarea{resize:vertical;min-height:80px;}
    .modal-actions{display:flex;gap:10px;margin-top:16px;}
    .btn-m{
      flex:1;padding:12px;border-radius:10px;border:none;
      font-family:'Rajdhani';font-weight:700;font-size:0.9rem;cursor:pointer;transition:0.2s;
    }
    .btn-m.cancel{background:var(--surface);color:var(--text-muted);border:1px solid var(--border);}
    .btn-m.cancel:hover{border-color:var(--accent);color:var(--accent);}
    .btn-m.confirm{background:linear-gradient(135deg,var(--accent3),#0891b2);color:#000;}
    .btn-m.confirm:hover{filter:brightness(1.1);}

    .empty{text-align:center;padding:50px 20px;color:var(--text-muted);border:1px dashed var(--border);border-radius:12px;}

    /* Bot贸n crear moderador flotante */
    .fab{
      position:fixed;bottom:28px;right:28px;
      background:linear-gradient(135deg,var(--accent3),#0891b2);
      color:#000;border:none;border-radius:50px;
      padding:14px 24px;font-family:'Rajdhani';font-weight:700;font-size:0.85rem;
      cursor:pointer;box-shadow:0 6px 20px rgba(6,182,212,0.35);transition:0.2s;
      display:flex;align-items:center;gap:8px;
    }
    .fab:hover{transform:translateY(-2px);filter:brightness(1.1);}
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav class="top-nav">
    <div style="display:flex;align-items:center;">
      <span class="brand">KOTATSU</span>
      <span class="role-tag"> Administrador</span>
    </div>
    <button class="logout" onclick="cerrarSesion()"><i class="fas fa-power-off"></i></button>
  </nav>

  <main class="container">
    <div class="profile-card">
      <img id="adminAvatar" class="avatar"
        src="data:image/svg+xml,<svg viewBox='0 0 1 1' fill='%231a1a28' xmlns='http://www.w3.org/2000/svg'><rect width='1' height='1'/></svg>"
        alt="Avatar" />
      <div class="profile-info">
        <p class="role-label"> Panel de Administraci贸n</p>
        <h2 id="adminName">Administrador</h2>
        <p style="color:var(--text-muted);font-size:0.75rem;" id="adminEmail"></p>
      </div>
    </div>

    <div class="panel-tabs">
      <button class="panel-tab active" onclick="switchTab('obras')"> Obras</button>
      <button class="panel-tab" onclick="switchTab('autores')"> Autores</button>
      <button class="panel-tab" onclick="switchTab('moderadores')"> Moderadores</button>
    </div>

    <div class="search-mini">
      <input type="text" id="searchBar" placeholder="Buscar..." oninput="filtrar()" />
    </div>

    <div id="tabContent"></div>
  </main>

  <!-- FAB: Crear moderador -->
  <button class="fab" onclick="abrirCrearMod()">
    <i class="fas fa-plus"></i> Nuevo Moderador
  </button>

  <!-- Modal -->
  <div class="overlay" id="modalOverlay">
    <div class="modal-box">
      <h3 id="modalTitulo">Acci贸n</h3>
      <div id="modalBody"></div>
      <div class="modal-actions">
        <button class="btn-m cancel" onclick="cerrarModal()">Cancelar</button>
        <button class="btn-m confirm" onclick="confirmar()">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireRole, clearSession } from "./staff_auth.js";
    import { loadEscritos } from "./escritos_data.js";

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd3a_Hx34raCWFXyzlLJsCSj1lfg84w79B5PWGoKu6YfRzt92E8giIMZZTl_M3f_FF/exec";

    if (!requireRole(["admin"])) {}

    document.getElementById("adminName").textContent  = localStorage.getItem("ktt_user")  || "Admin";
    document.getElementById("adminEmail").textContent = localStorage.getItem("ktt_email") || "";
    const f = localStorage.getItem("ktt_foto");
    if (f) document.getElementById("adminAvatar").src = f;

    let allObras   = [];
    let allAutores = [];
    let allMods    = [];
    let currentTab = "obras";
    let pendingAction = null;

    window.cerrarSesion = () => { clearSession(); window.location.href = "registrarse.html"; };

    async function cargar() {
      allObras   = await loadEscritos();
      try {
        const res  = await fetch(SCRIPT_URL, {
          method:"POST", headers:{"Content-Type":"text/plain"},
          body: JSON.stringify({ action:"getStaffList", rolReq:"admin" }),
        });
        const data = await res.json();
        allAutores = data.autores   || [];
        allMods    = data.moderadores || [];
      } catch {}
      renderTab();
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      document.querySelectorAll(".panel-tab").forEach((t, i) =>
        t.classList.toggle("active", ["obras","autores","moderadores"][i] === tab));
      document.getElementById("searchBar").value = "";
      renderTab();
    };

    function renderTab() {
      const q = (document.getElementById("searchBar")?.value || "").toLowerCase();
      const container = document.getElementById("tabContent");
      let html = "";

      if (currentTab === "obras") {
        const items = allObras.filter(o =>
          !q || o.titulo.toLowerCase().includes(q) || o.autor.toLowerCase().includes(q) || String(o.id).includes(q));
        if (!items.length) { container.innerHTML = `<div class="empty">No hay obras.</div>`; return; }
        html = items.map(o => {
          const ap = (o.aprobacion || "pendiente").toLowerCase();
          const bc = ap === "aprobado" ? "badge-aprobado" : ap === "rechazado" ? "badge-rechazado" : ap === "suspension" ? "badge-suspension" : "badge-pendiente";
          const cv = o.cover ? `<img src="${o.cover}" class="item-cover" alt="">` : `<div class="item-cover"></div>`;
          return `<div class="item-card">${cv}
            <div class="item-info">
              <h4>${o.titulo} <span class="badge ${bc}">${ap}</span></h4>
              <small>ID: ${o.id} 路 ${o.autor}</small>
            </div>
            <div class="item-actions">
              <button class="btn-action approve" onclick="accion('aprobado','obra','${o.id}')">Aprobar</button>
              <button class="btn-action review"  onclick="accion('revision','obra','${o.id}')">Revisi贸n</button>
              <button class="btn-action suspend" onclick="accion('suspension','obra','${o.id}')">Suspender</button>
            </div>
          </div>`;
        }).join("");

      } else if (currentTab === "autores") {
        const items = allAutores.filter(a =>
          !q || (a.nombre||"").toLowerCase().includes(q) || String(a.id_autor).includes(q));
        if (!items.length) { container.innerHTML = `<div class="empty">No hay autores.</div>`; return; }
        html = items.map(a => {
          const est = (a.estado||"activo").toLowerCase();
          const bc  = est === "suspendido" ? "badge-suspension" : "badge-activo";
          return `<div class="item-card">
            <div class="item-info">
              <h4>${a.nombre} <span class="badge ${bc}">${est}</span></h4>
              <small>ID: ${a.id_autor} 路 ${a.email||""}</small>
            </div>
            <div class="item-actions">
              ${est==="suspendido"
                ? `<button class="btn-action approve" onclick="accion('activar','autor','${a.id_autor}')">Activar</button>`
                : `<button class="btn-action suspend" onclick="accion('suspender','autor','${a.id_autor}')">Suspender</button>`}
            </div>
          </div>`;
        }).join("");

      } else {
        const items = allMods.filter(m =>
          !q || (m.nombre||"").toLowerCase().includes(q) || String(m.id_staff).includes(q));
        if (!items.length) { container.innerHTML = `<div class="empty">No hay moderadores.</div>`; return; }
        html = items.map(m => {
          const est = (m.estado||"activo").toLowerCase();
          const bc  = est==="suspendido" ? "badge-suspension" : "badge-mod";
          return `<div class="item-card">
            <div class="item-info">
              <h4>${m.nombre} <span class="badge ${bc}"> ${est}</span></h4>
              <small>ID: ${m.id_staff} 路 ${m.email||""}</small>
            </div>
            <div class="item-actions">
              ${est==="suspendido"
                ? `<button class="btn-action approve" onclick="accion('activar','moderador','${m.id_staff}')">Activar</button>`
                : `<button class="btn-action suspend" onclick="accion('suspender','moderador','${m.id_staff}')">Suspender</button>`}
            </div>
          </div>`;
        }).join("");
      }

      container.innerHTML = html;
    }

    window.filtrar = renderTab;

    //  Acci贸n con motivo 
    window.accion = function(tipo, targetType, targetId) {
      pendingAction = { tipo, targetType, targetId, mode:"action" };
      document.getElementById("modalTitulo").textContent = `Confirmar: ${tipo}`;
      document.getElementById("modalBody").innerHTML = `
        <div class="field"><label>Motivo</label>
          <textarea id="motivoInput" placeholder="Describe el motivo..."></textarea>
        </div>`;
      document.getElementById("modalOverlay").classList.add("open");
    };

    //  Crear moderador 
    window.abrirCrearMod = function() {
      pendingAction = { mode:"crearMod" };
      document.getElementById("modalTitulo").textContent = "Crear Moderador";
      document.getElementById("modalBody").innerHTML = `
        <div class="field"><label>Nombre</label><input type="text" id="newModNombre" placeholder="Nombre del moderador"></div>
        <div class="field"><label>Correo (@kots-stf-mod.com)</label><input type="email" id="newModEmail" placeholder="nombre@kots-stf-mod.com"></div>
        <div class="field"><label>Contrase帽a</label><input type="password" id="newModPass" placeholder="Contrase帽a segura"></div>`;
      document.getElementById("modalOverlay").classList.add("open");
    };

    window.cerrarModal = () => {
      document.getElementById("modalOverlay").classList.remove("open");
      pendingAction = null;
    };

    window.confirmar = async () => {
      if (!pendingAction) return;
      const { mode } = pendingAction;

      if (mode === "action") {
        const motivo = document.getElementById("motivoInput")?.value.trim();
        if (!motivo) { alert("Ingresa un motivo."); return; }
        const { tipo, targetType, targetId } = pendingAction;
        await fetch(SCRIPT_URL, {
          method:"POST", mode:"no-cors",
          body: JSON.stringify({
            action: targetType === "obra" ? "cambiarAprobacionObra" : "cambiarEstadoPersona",
            idStaff: localStorage.getItem("ktt_id"),
            targetType, targetId, nuevoEstado: tipo, motivo,
          }),
        });
      } else if (mode === "crearMod") {
        const nombre = document.getElementById("newModNombre").value.trim();
        const email  = document.getElementById("newModEmail").value.trim();
        const pass   = document.getElementById("newModPass").value.trim();
        if (!nombre || !email || !pass) { alert("Completa todos los campos."); return; }
        if (!email.endsWith("@kots-stf-mod.com")) { alert("El correo debe terminar en @kots-stf-mod.com"); return; }
        await fetch(SCRIPT_URL, {
          method:"POST", mode:"no-cors",
          body: JSON.stringify({
            action:"crearStaff", rol:"mod",
            nombre, email, pass,
            idAdmin: localStorage.getItem("ktt_id"),
          }),
        });
      }

      cerrarModal();
      setTimeout(() => cargar(), 1200);
    };

    cargar();
  </script>
</body>
</html>
