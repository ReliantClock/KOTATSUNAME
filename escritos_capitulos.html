<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Capítulos - Kotatsuname</title>
  <link rel="stylesheet" href="buscador.css" />
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    .nav-btn {
      display: inline-block;
      text-decoration: none;
      background: transparent;
      padding: 8px 18px;
      border-radius: 5px;
      color: #fff;
      font-family: var(--font-body);
      font-size: 0.8rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      border: 1px solid var(--accent);
      cursor: pointer;
      transition: all 0.3s;
    }
    .nav-btn:hover { background: var(--accent); box-shadow: 0 0 15px var(--accent); }

    /* ── Cabecera del libro ── */
    .book-header {
      display: flex;
      gap: 28px;
      align-items: flex-start;
      margin-bottom: 36px;
      flex-wrap: wrap;
    }

    /* Placeholder animado mientras carga */
    .book-cover-placeholder {
      width: 140px;
      height: 200px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--surface2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      animation: shimmer 1.4s ease-in-out infinite;
    }
    @keyframes shimmer {
      0%   { background-color: var(--surface2); border-color: var(--border); }
      50%  { background-color: #1e1e2e; border-color: rgba(230,62,109,0.2); }
      100% { background-color: var(--surface2); border-color: var(--border); }
    }

    /* Imagen: empieza invisible y aparece con fade al cargar */
    .book-cover-img {
      width: 140px;
      flex-shrink: 0;
      border-radius: 10px;
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(230,62,109,0.25);
      object-fit: cover;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    .book-cover-img.loaded {
      opacity: 1;
    }

    .book-info { flex: 1; min-width: 200px; }
    .book-info h1 {
      font-family: var(--font-display);
      font-size: clamp(1.2rem, 3vw, 2rem);
      background: linear-gradient(135deg, #fff 0%, var(--accent) 60%, var(--accent2) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin-bottom: 8px;
    }
    .book-info .author   { color: var(--text-muted); font-size: 0.95rem; margin-bottom: 10px; }
    .book-info .sinopsis { font-size: 0.9rem; color: var(--text-muted); line-height: 1.6; margin-bottom: 14px; }

    /* Estado con color dinámico — vacío por defecto, JS lo llena */
    .status-badge {
      display: inline-block;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      padding: 4px 12px;
      border-radius: 20px;
      border: 1px solid currentColor;
    }
    .status-emision  { color: #4CAF50; background: rgba(76,175,80,0.1); }
    .status-pausa    { color: #ff4444; background: rgba(255,68,68,0.1); }
    .status-completo { color: #00d4ff; background: rgba(0,212,255,0.1); }

    .separator { border: none; border-top: 1px solid var(--border); margin: 28px 0; }

    /* ── Volúmenes y capítulos ── */
    .volume-block { margin-bottom: 36px; }

    .volume-title {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--accent2);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 1px solid rgba(124,58,237,0.25);
    }

    .chapter-list { display: flex; flex-direction: column; gap: 8px; }

    .chapter-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .chapter-item:hover {
      border-color: var(--accent);
      background: var(--surface2);
      transform: translateX(4px);
      box-shadow: 0 0 12px rgba(230,62,109,0.15);
    }
    .chapter-item .cap-num {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .chapter-item .cap-label {
      font-size: 0.95rem;
      font-weight: 600;
      color: var(--text);
    }
    .chapter-item .cap-arrow {
      font-size: 0.85rem;
      color: var(--accent);
      font-weight: 700;
    }

    .empty-volumes {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="bg-glow"></div>

  <div class="wrapper">
    <nav style="padding: 20px 0 28px;">
      <a href="escritos.html" class="nav-btn"> Volver a la Biblioteca</a>
    </nav>

    <!-- Cabecera del libro -->
    <div class="book-header">
      <!-- El placeholder se reemplaza por la imagen al cargar -->
      <div id="bookCover" class="book-cover-placeholder"></div>
      <div class="book-info">
        <h1 id="bookTitle">Cargando...</h1>
        <p class="author" id="bookAuthor"></p>
        <div id="bookTags" style="display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px;"></div>
        <p class="sinopsis" id="bookSinopsis"></p>
        <!-- Estado: vacío en HTML, JS pone texto y clase según el Sheet -->
        <span id="bookStatus" class="status-badge"></span>
        <span style="margin-left:12px;font-size:0.85rem;color:var(--text-muted);" id="bookCaps"></span>
      </div>
    </div>

    <hr class="separator" />

    <h3 style="font-family:var(--font-display);font-size:1rem;letter-spacing:0.1em;margin-bottom:20px;color:var(--text-muted);">
      LISTA DE CAPÍTULOS
    </h3>

    <div id="volumeContainer"></div>

  </div>

  <script type="module">
    import { loadEscritos } from "./escritos_data.js";

    const params  = new URLSearchParams(window.location.search);
    const libroId = params.get("id");
    let globalCapNum = 0;

    async function cargarLibro() {
      if (!libroId) { window.location.href = "escritos.html"; return; }

      const libros = await loadEscritos();
      const libro  = libros.find(l => l.id == libroId);

      if (!libro) {
        document.getElementById("bookTitle").textContent = "Libro no encontrado";
        return;
      }

      // ── Portada con fade-in al cargar ──
      if (libro.cover) {
        const img = document.createElement("img");
        img.id        = "bookCover";
        img.className = "book-cover-img";
        img.alt       = libro.titulo;
        // fade-in cuando termina de cargar
        img.addEventListener("load",  () => img.classList.add("loaded"));
        img.addEventListener("error", () => {
          // Si falla, volvemos al placeholder con emoji
          img.replaceWith(Object.assign(
            document.createElement("div"),
            { id: "bookCover", className: "book-cover-placeholder", textContent: "" }
          ));
        });
        img.src = libro.cover; // src DESPUÉS de los listeners
        document.getElementById("bookCover").replaceWith(img);
      }

      // ── Info básica ──
      document.getElementById("bookTitle").textContent    = libro.titulo;
      document.getElementById("bookAuthor").textContent   = `Escrito por: ${libro.autor}`;
      document.getElementById("bookSinopsis").textContent = libro.sinopsis;
      document.getElementById("bookCaps").textContent     =
        `${libro.capitulos} capítulo${libro.capitulos !== 1 ? "s" : ""}`;

      // ── Tags géneros ──
      document.getElementById("bookTags").innerHTML = libro.generos
        .map(g => `<span class="modal-tag">${g}</span>`).join("");

      // ── Estado: leído desde el Sheet, nunca hardcodeado en HTML ──
      const statusEl  = document.getElementById("bookStatus");
      const estadoRaw = (libro.estado || "").trim().toLowerCase();

      if (estadoRaw === "completado" || estadoRaw === "finalizado") {
        statusEl.textContent = "Completado";
        statusEl.className   = "status-badge status-completo";
      } else if (estadoRaw === "pausa" || estadoRaw === "en pausa") {
        statusEl.textContent = "En Pausa";
        statusEl.className   = "status-badge status-pausa";
      } else {
        // "en emisión" u cualquier otro valor → verde
        statusEl.textContent = "En Emisión";
        statusEl.className   = "status-badge status-emision";
      }

      // ── Volúmenes ──
      const container = document.getElementById("volumeContainer");

      if (!libro.volumenes || libro.volumenes.length === 0) {
        container.innerHTML = `<div class="empty-volumes">Aún no hay capítulos disponibles.</div>`;
        return;
      }

      libro.volumenes.forEach(vol => {
        const block = document.createElement("div");
        block.className = "volume-block";

        const capItems = vol.capitulos.map(cap => {
          globalCapNum++;
          const gNum = globalCapNum;
          return `
            <div class="chapter-item"
                 data-id="${libroId}"
                 data-vol="${vol.numero}"
                 data-cap="${cap.numero}"
                 data-gnum="${gNum}">
              <span class="cap-num">Cap. ${gNum}</span>
              <span class="cap-label">Capítulo ${gNum}</span>
              <span class="cap-arrow">Leer</span>
            </div>
          `;
        }).join("");

        block.innerHTML = `
          <div class="volume-title">Volumen ${vol.numero}</div>
          <div class="chapter-list">${capItems}</div>
        `;
        container.appendChild(block);
      });

      container.addEventListener("click", e => {
        const item = e.target.closest(".chapter-item");
        if (!item) return;
        window.location.href =
          `libro_capitulo.html?id=${item.dataset.id}&vol=${item.dataset.vol}&cap=${item.dataset.cap}&gnum=${item.dataset.gnum}`;
      });
    }

    cargarLibro();
  </script>
</body>
</html>