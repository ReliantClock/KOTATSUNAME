<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel Admin | Sistema</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Rajdhani', sans-serif; }
    .top-nav { display: flex; justify-content: space-between; align-items: center; padding: 14px 24px; border-bottom: 1px solid var(--border); background: rgba(10,10,15,0.9); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 50; }
    .brand { font-family: 'Cinzel Decorative'; color: #f59e0b; font-size: 1rem; }
    .nav-right { display: flex; align-items: center; gap: 16px; }
    .rol-badge { background: rgba(245,158,11,0.12); border: 1px solid #f59e0b; color: #f59e0b; padding: 4px 12px; border-radius: 20px; font-size: 0.7rem; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; }
    .logout-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 1rem; }
    .logout-btn:hover { color: var(--accent); }
    .container { max-width: 1000px; margin: 0 auto; padding: 28px 20px 80px; }
    .tabs { display: flex; gap: 4px; margin-bottom: 28px; border-bottom: 1px solid var(--border); }
    .tab { padding: 12px 20px; cursor: pointer; font-weight: 700; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); border-bottom: 2px solid transparent; transition: 0.2s; }
    .tab.active { color: #f59e0b; border-bottom-color: #f59e0b; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; }
    .section-title { font-size: 0.72rem; font-weight: 700; letter-spacing: 3px; text-transform: uppercase; color: #f59e0b; margin-bottom: 14px; }
    .filtros { display: flex; gap: 10px; margin-bottom: 18px; flex-wrap: wrap; }
    .filtro-btn { background: var(--surface); border: 1px solid var(--border); color: var(--text-muted); padding: 7px 16px; border-radius: 20px; font-family: 'Rajdhani'; font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .filtro-btn.active, .filtro-btn:hover { border-color: #f59e0b; color: #f59e0b; }
    .obra-card, .autor-card, .form-card { background: var(--surface); border: 1px solid var(--border); border-radius: 14px; padding: 16px 20px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; gap: 16px; flex-wrap: wrap; }
    .obra-card:hover, .autor-card:hover { border-color: rgba(245,158,11,0.3); }
    .info h4 { margin: 0 0 4px; color: #fff; font-size: 1rem; }
    .info small { color: var(--text-muted); font-size: 0.75rem; }
    .badge { display: inline-block; font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; margin-left: 8px; text-transform: uppercase; }
    .badge-pendiente { color: #f59e0b; background: rgba(245,158,11,0.12); border: 1px solid #f59e0b; }
    .badge-aprobado  { color: #4CAF50; background: rgba(76,175,80,0.12); border: 1px solid #4CAF50; }
    .badge-rechazado { color: var(--accent); background: rgba(230,62,109,0.1); border: 1px solid var(--accent); }
    .badge-suspendido { color: #ef4444; background: rgba(239,68,68,0.1); border: 1px solid #ef4444; }
    .badge-activo { color: #4CAF50; background: rgba(76,175,80,0.12); border: 1px solid #4CAF50; }
    .acciones { display: flex; gap: 8px; flex-wrap: wrap; }
    .btn-acc { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 6px 12px; border-radius: 8px; font-family: 'Rajdhani'; font-size: 0.72rem; font-weight: 700; cursor: pointer; transition: 0.2s; }
    .btn-acc.yellow { border-color: #f59e0b; color: #f59e0b; }
    .btn-acc.yellow:hover { background: #f59e0b; color: #000; }
    .btn-acc.red { border-color: var(--accent); color: var(--accent); }
    .btn-acc.red:hover { background: var(--accent); color: #fff; }
    .btn-acc.green { border-color: #4CAF50; color: #4CAF50; }
    .btn-acc.green:hover { background: #4CAF50; color: #000; }
    .form-card { flex-direction: column; align-items: stretch; gap: 14px; }
    .form-card h3 { font-family: 'Cinzel Decorative'; font-size: 0.85rem; color: #f59e0b; margin: 0; }
    .form-row { display: flex; gap: 12px; flex-wrap: wrap; }
    .form-row input { flex: 1; min-width: 180px; background: #0a0a0f; border: 1px solid var(--border); padding: 11px 14px; border-radius: 10px; color: #fff; font-family: 'Rajdhani'; font-size: 0.95rem; outline: none; transition: 0.2s; }
    .form-row input:focus { border-color: #f59e0b; }
    .btn-agregar { background: #f59e0b; border: none; color: #000; padding: 11px 24px; border-radius: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; white-space: nowrap; }
    .btn-agregar:hover { filter: brightness(1.1); }
    .form-msg { font-size: 0.85rem; color: var(--accent3); min-height: 1.2rem; }
    .empty { text-align: center; padding: 40px 20px; color: var(--text-muted); }
    .empty i { font-size: 2rem; display: block; margin-bottom: 12px; opacity: 0.3; }
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; z-index: 200; padding: 20px; }
    .modal-overlay.open { display: flex; }
    .modal-box { background: #12121e; border: 1px solid var(--border); border-radius: 20px; padding: 28px; width: 100%; max-width: 480px; }
    .modal-box h3 { font-family: 'Cinzel Decorative'; font-size: 0.9rem; color: #fff; margin-bottom: 8px; }
    .modal-sub { color: var(--accent3); margin-bottom: 20px; font-size: 0.9rem; }
    .modal-box label { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 8px; font-weight: 700; }
    .modal-box select, .modal-box textarea { width: 100%; background: #0a0a0f; border: 1px solid var(--border); padding: 12px 14px; border-radius: 10px; color: #fff; font-family: 'Rajdhani'; font-size: 0.95rem; outline: none; box-sizing: border-box; margin-bottom: 16px; }
    .modal-box textarea { resize: vertical; min-height: 80px; }
    .modal-btns { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-cancel-m { background: none; border: 1px solid var(--border); color: var(--text-muted); padding: 10px 20px; border-radius: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; }
    .btn-confirm { background: #f59e0b; border: none; color: #000; padding: 10px 24px; border-radius: 10px; font-family: 'Rajdhani'; font-weight: 700; cursor: pointer; }
    .modal-err { color: var(--accent); font-size: 0.85rem; margin-bottom: 12px; min-height: 1.2rem; }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <nav class="top-nav">
    <span class="brand">SYSCTL — LV2</span>
    <div class="nav-right">
      <span class="rol-badge">Administrador</span>
      <span id="navNombre" style="color:var(--text-muted);font-size:0.85rem;"></span>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-power-off"></i></button>
    </div>
  </nav>

  <main class="container">
    <div class="tabs">
      <div class="tab active" onclick="showTab('obras',this)">Obras</div>
      <div class="tab" onclick="showTab('autores',this)">Autores</div>
      <div class="tab" onclick="showTab('staff',this)">Agregar Moderador</div>
    </div>

    <div class="tab-panel active" id="tab-obras">
      <p class="section-title">Gestión de Obras</p>
      <div class="filtros">
        <button class="filtro-btn active" onclick="filtrarObras('todos',this)">Todas</button>
        <button class="filtro-btn" onclick="filtrarObras('pendiente',this)">Pendientes</button>
        <button class="filtro-btn" onclick="filtrarObras('aprobado',this)">Aprobadas</button>
        <button class="filtro-btn" onclick="filtrarObras('suspendido',this)">Suspendidas</button>
      </div>
      <div id="listaObras"><div class="empty"><i class="fas fa-spinner fa-spin"></i> Cargando...</div></div>
    </div>

    <div class="tab-panel" id="tab-autores">
      <p class="section-title">Gestión de Autores</p>
      <div id="listaAutores"><div class="empty"><i class="fas fa-spinner fa-spin"></i> Cargando...</div></div>
    </div>

    <div class="tab-panel" id="tab-staff">
      <p class="section-title">Agregar Moderador</p>
      <div class="form-card">
        <h3>Nuevo Moderador</h3>
        <div class="form-row">
          <input type="text" id="modNombre" placeholder="Nombre del moderador" />
          <input type="email" id="modEmail" placeholder="Email de Google" />
        </div>
        <div>
          <button class="btn-agregar" onclick="agregarModerador()">Agregar Moderador</button>
        </div>
        <div class="form-msg" id="staffMsg"></div>
      </div>
    </div>
  </main>

  <div class="modal-overlay" id="modalAccion">
    <div class="modal-box">
      <h3 id="modalTituloAcc">Acción</h3>
      <p class="modal-sub" id="modalSubAcc"></p>
      <div id="modalSelectWrap">
        <label>Nuevo Estado</label>
        <select id="selectEstado">
          <option value="pendiente">Pendiente</option>
          <option value="aprobado">Aprobado</option>
          <option value="suspendido">Suspendido</option>
        </select>
      </div>
      <label>Motivo (obligatorio)</label>
      <textarea id="motivoAcc" placeholder="Explica el motivo..."></textarea>
      <div class="modal-err" id="modalErr"></div>
      <div class="modal-btns">
        <button class="btn-cancel-m" onclick="cerrarModal()">Cancelar</button>
        <button class="btn-confirm" id="btnConfirmar" onclick="confirmar()">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    const S2 = "https://script.google.com/macros/s/AKfycbyBQSJ0LaCBCEzdIYZkDOaVU8qTP2uivgHGZEmjI10Ew8TQ_75XtnYbJfnCMF_f6i-Bpw/exec";
    const email  = localStorage.getItem("ktt_email") || "";
    const nombre = localStorage.getItem("ktt_user")  || "";
    const rol    = localStorage.getItem("ktt_rol")   || "";

    if (!email || !["admin","dueno"].includes(rol)) {
      window.location.href = "registrarse.html";
    }
    document.getElementById("navNombre").textContent = nombre;

    let obras = [], autores = [];
    let filtroObras = "todos";
    let accionActual = null;
    let targetId = null;

    window.showTab = (tab, el) => {
      document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));
      document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
      document.getElementById("tab-" + tab).classList.add("active");
      el.classList.add("active");
      if (tab === "autores" && !autores.length) cargarAutores();
    };

    async function cargarObras() {
      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ action:"getObras", emailSolicitante: email }) });
        const data = await res.json();
        if (data.status !== "success") { document.getElementById("listaObras").innerHTML = `<div class="empty">${data.message}</div>`; return; }
        obras = data.obras || [];
        renderObras();
      } catch(e) { document.getElementById("listaObras").innerHTML = `<div class="empty">Error de conexión.</div>`; }
    }

    function renderObras() {
      const f = filtroObras === "todos" ? obras : obras.filter(o => (o.aprobacion||"").toLowerCase() === filtroObras);
      if (!f.length) { document.getElementById("listaObras").innerHTML = `<div class="empty"><i class="fas fa-scroll"></i> Sin resultados.</div>`; return; }
      document.getElementById("listaObras").innerHTML = f.map(o => {
        const ap = (o.aprobacion||"pendiente").toLowerCase();
        const bc = ap === "aprobado" ? "badge-aprobado" : ap === "suspendido" ? "badge-suspendido" : ap === "rechazado" ? "badge-rechazado" : "badge-pendiente";
        const tit = o.titulo.replace(/'/g,"\\'");
        return `<div class="obra-card"><div class="info"><h4>${o.titulo}<span class="badge ${bc}">${ap}</span></h4><small>Autor: ${o.autor} · ${o.capitulos||0} caps</small></div><div class="acciones"><button class="btn-acc yellow" onclick="abrirModalObra('${o.id}','${tit}')">Cambiar Estado</button></div></div>`;
      }).join("");
    }

    window.filtrarObras = (f, btn) => {
      filtroObras = f;
      document.querySelectorAll("#tab-obras .filtro-btn").forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      renderObras();
    };

    async function cargarAutores() {
      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ action:"getAutores", emailSolicitante: email }) });
        const data = await res.json();
        if (data.status !== "success") { document.getElementById("listaAutores").innerHTML = `<div class="empty">${data.message}</div>`; return; }
        autores = data.autores || [];
        renderAutores();
      } catch(e) { document.getElementById("listaAutores").innerHTML = `<div class="empty">Error de conexión.</div>`; }
    }

    function renderAutores() {
      if (!autores.length) { document.getElementById("listaAutores").innerHTML = `<div class="empty"><i class="fas fa-users"></i> No hay autores.</div>`; return; }
      document.getElementById("listaAutores").innerHTML = autores.map(a => {
        const susp = a.suspendido;
        const emailSafe = a.email.replace(/'/g,"\\'");
        const nomSafe  = a.nombre.replace(/'/g,"\\'");
        return `<div class="autor-card"><div class="info"><h4>${a.nombre}<span class="badge ${susp ? "badge-suspendido" : "badge-activo"}">${susp ? "Suspendido" : "Activo"}</span></h4><small>${a.email}${susp ? " · " + a.motivo : ""}</small></div><div class="acciones">${susp
          ? `<button class="btn-acc green" onclick="abrirModalReactivar('${emailSafe}','${nomSafe}')">Reactivar</button>`
          : `<button class="btn-acc red" onclick="abrirModalSuspender('${emailSafe}','${nomSafe}')">Suspender</button>`
        }</div></div>`;
      }).join("");
    }

    window.abrirModalObra = (id, titulo) => {
      accionActual = "obra";
      targetId = id;
      document.getElementById("modalTituloAcc").textContent  = "Cambiar Estado";
      document.getElementById("modalSubAcc").textContent     = titulo;
      document.getElementById("modalSelectWrap").style.display = "block";
      document.getElementById("motivoAcc").value = "";
      document.getElementById("modalErr").textContent = "";
      document.getElementById("modalAccion").classList.add("open");
    };

    window.abrirModalSuspender = (emailAut, nombre) => {
      accionActual = "suspender";
      targetId = emailAut;
      document.getElementById("modalTituloAcc").textContent  = "Suspender Autor";
      document.getElementById("modalSubAcc").textContent     = nombre;
      document.getElementById("modalSelectWrap").style.display = "none";
      document.getElementById("motivoAcc").value = "";
      document.getElementById("modalErr").textContent = "";
      document.getElementById("modalAccion").classList.add("open");
    };

    window.abrirModalReactivar = (emailAut, nombre) => {
      accionActual = "reactivar";
      targetId = emailAut;
      document.getElementById("modalTituloAcc").textContent  = "Reactivar Autor";
      document.getElementById("modalSubAcc").textContent     = nombre;
      document.getElementById("modalSelectWrap").style.display = "none";
      document.getElementById("motivoAcc").placeholder = "Motivo de reactivación (opcional)";
      document.getElementById("motivoAcc").value = "";
      document.getElementById("modalErr").textContent = "";
      document.getElementById("modalAccion").classList.add("open");
    };

    window.cerrarModal = () => { document.getElementById("modalAccion").classList.remove("open"); accionActual = null; targetId = null; };

    window.confirmar = async () => {
      const motivo = document.getElementById("motivoAcc").value.trim();
      const errEl  = document.getElementById("modalErr");
      if (accionActual !== "reactivar" && !motivo) { errEl.textContent = "El motivo es obligatorio."; return; }
      errEl.textContent = "Guardando...";

      let payload = { emailSolicitante: email };
      if (accionActual === "obra") {
        payload.action = "cambiarEstadoObra";
        payload.idObra = targetId;
        payload.nuevoEstado = document.getElementById("selectEstado").value;
        payload.motivo = motivo;
      } else if (accionActual === "suspender") {
        payload.action = "suspenderAutor";
        payload.emailAutor = targetId;
        payload.motivo = motivo;
      } else if (accionActual === "reactivar") {
        payload.action = "reactivarAutor";
        payload.emailAutor = targetId;
      }

      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify(payload) });
        const data = await res.json();
        if (data.status === "success") {
          cerrarModal();
          if (accionActual === "obra") cargarObras();
          else { autores = []; cargarAutores(); }
        } else {
          errEl.textContent = data.message || "Error.";
        }
      } catch(e) { errEl.textContent = "Error de conexión."; }
    };

    window.agregarModerador = async () => {
      const nom   = document.getElementById("modNombre").value.trim();
      const mail  = document.getElementById("modEmail").value.trim();
      const msgEl = document.getElementById("staffMsg");
      if (!nom || !mail) { msgEl.style.color = "var(--accent)"; msgEl.textContent = "Completa nombre y email."; return; }
      msgEl.textContent = "Guardando...";
      try {
        const res  = await fetch(S2, { method:"POST", headers:{"Content-Type":"text/plain"}, body: JSON.stringify({ action:"agregarStaff", emailSolicitante: email, nuevoNombre: nom, nuevoEmail: mail, nuevoRol: "moderador" }) });
        const data = await res.json();
        if (data.status === "success") {
          msgEl.style.color = "var(--accent3)";
          msgEl.textContent = "Moderador agregado correctamente.";
          document.getElementById("modNombre").value = "";
          document.getElementById("modEmail").value  = "";
        } else {
          msgEl.style.color = "var(--accent)";
          msgEl.textContent = data.message || "Error.";
        }
      } catch(e) { msgEl.style.color = "var(--accent)"; msgEl.textContent = "Error de conexión."; }
    };

    window.logout = () => { localStorage.clear(); window.location.href = "registrarse.html"; };
    cargarObras();
  </script>
</body>
</html>
