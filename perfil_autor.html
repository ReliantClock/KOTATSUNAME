<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel DueÃ±o | Kotatsu</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel+Decorative:wght@700&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="buscador.css">
  <style>
    body{margin:0;background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;}

    .top-nav{
      display:flex;justify-content:space-between;align-items:center;
      padding:14px 24px;border-bottom:1px solid var(--border);
      background:rgba(10,10,15,0.9);backdrop-filter:blur(12px);
      position:sticky;top:0;z-index:50;
    }
    .brand{font-family:'Cinzel Decorative';color:var(--accent);font-size:1.1rem;}
    .role-tag{
      font-size:0.65rem;font-weight:700;letter-spacing:0.2em;text-transform:uppercase;
      padding:3px 10px;border-radius:20px;
      border:1px solid var(--accent);color:var(--accent);background:rgba(230,62,109,0.08);margin-left:10px;
    }
    .logout{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1.1rem;transition:0.2s;}
    .logout:hover{color:var(--accent);}

    .container{max-width:1100px;margin:0 auto;padding:28px 20px 80px;}

    /* Perfil */
    .profile-card{
      display:flex;align-items:center;gap:20px;
      background:var(--surface);border:1px solid rgba(230,62,109,0.3);
      border-radius:18px;padding:20px 24px;margin-bottom:28px;flex-wrap:wrap;
      box-shadow:0 0 30px rgba(230,62,109,0.06);
    }
    .avatar-wrap{position:relative;width:80px;height:80px;flex-shrink:0;}
    .avatar-wrap img{
      width:100%;height:100%;border-radius:50%;object-fit:cover;
      border:3px solid var(--accent);background:#1a1a28;display:block;
    }
    .avatar-btn{
      position:absolute;bottom:2px;right:2px;width:26px;height:26px;border-radius:50%;
      background:var(--accent);border:2px solid var(--surface);color:#fff;
      font-size:0.65rem;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:0.2s;
    }
    .avatar-btn:hover{transform:scale(1.1);}
    .photo-drawer{
      background:#12121e;border:1px solid var(--border);border-top:none;
      border-radius:0 0 18px 18px;max-height:0;overflow:hidden;
      transition:max-height 0.4s,padding 0.3s,opacity 0.3s;opacity:0;
    }
    .photo-drawer.open{max-height:140px;padding:16px 24px;opacity:1;}
    .photo-row{display:flex;gap:10px;}
    .photo-row input{
      flex:1;background:#0a0a0f;border:1px solid var(--border);padding:10px 13px;
      border-radius:10px;color:#fff;font-family:'Rajdhani';font-size:0.9rem;outline:none;transition:0.2s;
    }
    .photo-row input:focus{border-color:var(--accent);}
    .photo-row button{
      background:var(--accent);color:#fff;border:none;padding:0 18px;
      border-radius:10px;font-weight:700;font-family:'Rajdhani';cursor:pointer;font-size:0.85rem;
    }
    .profile-info .role-label{color:var(--accent);font-size:0.65rem;letter-spacing:3px;font-weight:700;text-transform:uppercase;}
    .profile-info h2{color:#fff;margin:4px 0 0;font-size:1.3rem;}

    /* Stats */
    .stats-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px;margin-bottom:28px;}
    .stat-card{
      background:var(--surface);border:1px solid var(--border);border-radius:12px;
      padding:16px;text-align:center;
    }
    .stat-card .num{font-size:1.8rem;font-weight:700;color:var(--accent);font-family:'Cinzel Decorative';}
    .stat-card .lbl{font-size:0.68rem;color:var(--text-muted);letter-spacing:0.15em;text-transform:uppercase;margin-top:4px;}

    /* Tabs */
    .panel-tabs{display:flex;gap:0;margin-bottom:24px;border:1px solid var(--border);border-radius:12px;overflow:hidden;flex-wrap:wrap;}
    .panel-tab{
      flex:1;min-width:80px;padding:11px 8px;background:transparent;border:none;
      color:var(--text-muted);font-family:'Rajdhani';font-size:0.72rem;font-weight:700;
      letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:0.2s;
    }
    .panel-tab.active{background:rgba(230,62,109,0.1);color:var(--accent);border-bottom:2px solid var(--accent);}

    /* Filtros */
    .filter-row{display:flex;gap:10px;margin-bottom:18px;flex-wrap:wrap;}
    .filter-row input,.filter-row select{
      background:var(--surface);border:1px solid var(--border);
      padding:9px 13px;border-radius:10px;color:#fff;outline:none;
      font-family:'Rajdhani';font-size:0.9rem;transition:0.2s;
    }
    .filter-row input{flex:1;min-width:140px;}
    .filter-row input:focus,.filter-row select:focus{border-color:var(--accent);}
    .filter-row select option{background:#1a1a28;}

    /* Cards */
    .item-card{
      background:var(--surface);border:1px solid var(--border);
      border-radius:12px;padding:14px 18px;
      display:flex;align-items:center;gap:14px;
      margin-bottom:10px;transition:border-color 0.2s;flex-wrap:wrap;
    }
    .item-card:hover{border-color:rgba(230,62,109,0.3);}
    .item-cover{
      width:46px;height:64px;border-radius:6px;object-fit:cover;
      border:1px solid var(--border);flex-shrink:0;background:var(--surface2);
      display:flex;align-items:center;justify-content:center;font-size:1.1rem;
    }
    .item-info{flex:1;min-width:0;}
    .item-info h4{margin:0 0 3px;color:#fff;font-size:0.93rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .item-info small{color:var(--text-muted);font-size:0.73rem;}

    .badge{display:inline-block;font-size:0.6rem;font-weight:700;padding:2px 7px;border-radius:10px;margin-left:5px;text-transform:uppercase;}
    .badge-aprobado {color:#4CAF50;background:rgba(76,175,80,0.1); border:1px solid #4CAF50;}
    .badge-pendiente{color:#f59e0b;background:rgba(245,158,11,0.1);border:1px solid #f59e0b;}
    .badge-suspension,.badge-rechazado{color:var(--accent);background:rgba(230,62,109,0.1);border:1px solid var(--accent);}
    .badge-activo{color:#4CAF50;background:rgba(76,175,80,0.1);border:1px solid #4CAF50;}
    .badge-mod  {color:#f59e0b;background:rgba(245,158,11,0.08);border:1px solid #f59e0b;}
    .badge-admin{color:var(--accent3);background:rgba(6,182,212,0.08);border:1px solid var(--accent3);}

    .item-actions{display:flex;gap:6px;flex-wrap:wrap;}
    .btn-action{
      background:none;border:1px solid var(--border);color:var(--text-muted);
      padding:5px 10px;border-radius:7px;cursor:pointer;font-family:'Rajdhani';
      font-size:0.72rem;font-weight:700;transition:0.2s;white-space:nowrap;
    }
    .btn-action.approve{border-color:#4CAF50;color:#4CAF50;}
    .btn-action.approve:hover{background:#4CAF50;color:#000;}
    .btn-action.danger{border-color:var(--accent);color:var(--accent);}
    .btn-action.danger:hover{background:var(--accent);color:#fff;}
    .btn-action.edit{border-color:var(--accent3);color:var(--accent3);}
    .btn-action.edit:hover{background:var(--accent3);color:#000;}
    .btn-action.del{border-color:#ff4444;color:#ff4444;}
    .btn-action.del:hover{background:#ff4444;color:#fff;}

    /* Modal */
    .overlay{
      position:fixed;inset:0;background:rgba(0,0,0,0.82);
      display:flex;align-items:center;justify-content:center;
      z-index:200;padding:20px;opacity:0;pointer-events:none;transition:opacity 0.3s;
    }
    .overlay.open{opacity:1;pointer-events:all;}
    .modal-box{
      background:#12121e;border:1px solid var(--border);
      border-radius:20px;padding:28px;width:100%;max-width:500px;
      transform:scale(0.95);transition:transform 0.3s;max-height:90vh;overflow-y:auto;
    }
    .overlay.open .modal-box{transform:scale(1);}
    .modal-box h3{font-family:'Cinzel Decorative';color:var(--accent);margin:0 0 18px;font-size:1rem;}
    .field{margin-bottom:13px;}
    .field label{display:block;font-size:0.67rem;color:var(--text-muted);font-weight:700;letter-spacing:2px;text-transform:uppercase;margin-bottom:6px;}
    .field input,.field textarea,.field select{
      width:100%;background:#0a0a0f;border:1px solid var(--border);
      padding:11px 13px;border-radius:10px;color:#fff;font-family:'Rajdhani';
      font-size:0.9rem;outline:none;transition:0.2s;box-sizing:border-box;
    }
    .field input:focus,.field textarea:focus,.field select:focus{border-color:var(--accent);}
    .field textarea{resize:vertical;min-height:80px;}
    .field select option{background:#1a1a28;}
    .modal-actions{display:flex;gap:10px;margin-top:18px;}
    .btn-m{
      flex:1;padding:12px;border-radius:10px;border:none;
      font-family:'Rajdhani';font-weight:700;font-size:0.9rem;cursor:pointer;transition:0.2s;
    }
    .btn-m.cancel{background:var(--surface);color:var(--text-muted);border:1px solid var(--border);}
    .btn-m.cancel:hover{border-color:var(--accent);color:var(--accent);}
    .btn-m.confirm{background:linear-gradient(135deg,var(--accent),#7c3aed);color:#fff;}
    .btn-m.confirm:hover{filter:brightness(1.1);}
    .btn-m.danger-confirm{background:linear-gradient(135deg,#ff4444,var(--accent));color:#fff;}

    .fab{
      position:fixed;bottom:28px;right:28px;
      background:linear-gradient(135deg,var(--accent),#7c3aed);
      color:#fff;border:none;border-radius:50px;
      padding:13px 22px;font-family:'Rajdhani';font-weight:700;font-size:0.82rem;
      cursor:pointer;box-shadow:0 6px 20px rgba(230,62,109,0.35);transition:0.2s;
      display:flex;align-items:center;gap:8px;
    }
    .fab:hover{transform:translateY(-2px);filter:brightness(1.1);}

    .empty{text-align:center;padding:50px 20px;color:var(--text-muted);border:1px dashed var(--border);border-radius:12px;}
  </style>
</head>
<body>
  <div class="bg-grid"></div>

  <nav class="top-nav">
    <div style="display:flex;align-items:center;">
      <span class="brand">KOTATSUNAME</span>
      <span class="role-tag"> DueÃ±o</span>
    </div>
    <button class="logout" onclick="cerrarSesion()"><i class="fas fa-power-off"></i></button>
  </nav>

  <main class="container">
    <!-- Perfil -->
    <div style="margin-bottom:20px;">
      <div class="profile-card">
        <div class="avatar-wrap">
          <img id="ownerAvatar"
            src="data:image/svg+xml,<svg viewBox='0 0 1 1' fill='%231a1a28' xmlns='http://www.w3.org/2000/svg'><rect width='1' height='1'/></svg>"
            alt="Avatar" />
          <button class="avatar-btn" onclick="togglePhotoDrawer()"><i class="fas fa-camera"></i></button>
        </div>
        <div class="profile-info">
          <p class="role-label"> Panel del DueÃ±o</p>
          <h2 id="ownerName">DueÃ±o</h2>
          <p style="color:var(--text-muted);font-size:0.75rem;" id="ownerEmail"></p>
        </div>
      </div>
      <div class="photo-drawer" id="photoDrawer">
        <div class="photo-row">
          <input type="text" id="driveInput" placeholder="Link de Google Drive para la foto..." />
          <button onclick="guardarFoto()">Actualizar</button>
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-row">
      <div class="stat-card"><div class="num" id="statObras">-</div><div class="lbl">Obras</div></div>
      <div class="stat-card"><div class="num" id="statAutores">-</div><div class="lbl">Autores</div></div>
      <div class="stat-card"><div class="num" id="statMods">-</div><div class="lbl">Moderadores</div></div>
      <div class="stat-card"><div class="num" id="statAdmins">-</div><div class="lbl">Admins</div></div>
    </div>

    <!-- Tabs -->
    <div class="panel-tabs">
      <button class="panel-tab active" onclick="switchTab('obras')"> Obras</button>
      <button class="panel-tab" onclick="switchTab('autores')">ðŸ‘¤ Autores</button>
      <button class="panel-tab" onclick="switchTab('moderadores')"> Mods</button>
      <button class="panel-tab" onclick="switchTab('admins')"> Admins</button>
    </div>

    <!-- Filtros -->
    <div class="filter-row">
      <input type="text" id="searchBar" placeholder="Buscar por tÃ­tulo, nombre, ID..." oninput="filtrar()" />
      <select id="filterEstado" onchange="filtrar()">
        <option value="">Todos los estados</option>
        <option value="aprobado">Aprobado</option>
        <option value="pendiente">Pendiente</option>
        <option value="suspension">Suspendido</option>
        <option value="revision">En revisiÃ³n</option>
      </select>
    </div>

    <div id="tabContent"></div>
  </main>

  <button class="fab" onclick="abrirCrearAdmin()">
    <i class="fas fa-plus"></i> Nuevo Admin
  </button>

  <!-- Modal -->
  <div class="overlay" id="modalOverlay">
    <div class="modal-box">
      <h3 id="modalTitulo">AcciÃ³n</h3>
      <div id="modalBody"></div>
      <div class="modal-actions" id="modalActions">
        <button class="btn-m cancel" onclick="cerrarModal()">Cancelar</button>
        <button class="btn-m confirm" id="btnConfirm" onclick="confirmar()">Confirmar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { requireRole, clearSession } from "./staff_auth.js";
    import { loadEscritos } from "./escritos_data.js";

    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwd3a_Hx34raCWFXyzlLJsCSj1lfg84w79B5PWGoKu6YfRzt92E8giIMZZTl_M3f_FF/exec";

    if (!requireRole(["owner"])) {}

    const ownerId    = localStorage.getItem("ktt_id");
    const ownerEmail = localStorage.getItem("ktt_email") || "";
    const ownerName  = localStorage.getItem("ktt_user")  || "DueÃ±o";
    const ownerFoto  = localStorage.getItem("ktt_foto")  || "";

    document.getElementById("ownerName").textContent  = ownerName;
    document.getElementById("ownerEmail").textContent = ownerEmail;
    if (ownerFoto) document.getElementById("ownerAvatar").src = ownerFoto;

    window.cerrarSesion = () => { clearSession(); window.location.href = "registrarse.html"; };

    window.togglePhotoDrawer = () => document.getElementById("photoDrawer").classList.toggle("open");
    window.guardarFoto = async () => {
      const val = document.getElementById("driveInput").value.trim();
      if (!val) return;
      const match = val.match(/[-\w]{25,}/);
      if (!match) { alert("Link invÃ¡lido."); return; }
      const url = `https://wsrv.nl/?url=${encodeURIComponent(`https://drive.google.com/uc?export=view&id=${match[0]}`)}&w=300&output=webp`;
      document.getElementById("ownerAvatar").src = url;
      localStorage.setItem("ktt_foto", url);
      document.getElementById("photoDrawer").classList.remove("open");
      await fetch(SCRIPT_URL, {
        method:"POST", mode:"no-cors",
        body: JSON.stringify({ action:"actualizarFotoStaff", idStaff: ownerId, foto: url }),
      });
    };

    let allObras=[], allAutores=[], allMods=[], allAdmins=[];
    let currentTab="obras";
    let pendingAction=null;

    async function cargar() {
      allObras = await loadEscritos();
      try {
        const res  = await fetch(SCRIPT_URL, {
          method:"POST", headers:{"Content-Type":"text/plain"},
          body: JSON.stringify({ action:"getStaffList", rolReq:"owner", idOwner: ownerId }),
        });
        const data = await res.json();
        allAutores = data.autores    || [];
        allMods    = data.moderadores || [];
        allAdmins  = data.admins     || [];
      } catch {}

      // Stats
      document.getElementById("statObras").textContent   = allObras.length;
      document.getElementById("statAutores").textContent = allAutores.length;
      document.getElementById("statMods").textContent    = allMods.length;
      document.getElementById("statAdmins").textContent  = allAdmins.length;
      renderTab();
    }

    window.switchTab = function(tab) {
      currentTab = tab;
      document.querySelectorAll(".panel-tab").forEach((t,i) =>
        t.classList.toggle("active", ["obras","autores","moderadores","admins"][i]===tab));
      renderTab();
    };

    function renderTab() {
      const q   = (document.getElementById("searchBar")?.value||"").toLowerCase();
      const est = document.getElementById("filterEstado")?.value||"";
      const container = document.getElementById("tabContent");
      let html="";

      if (currentTab==="obras") {
        const items = allObras.filter(o=>{
          if (q && !o.titulo.toLowerCase().includes(q) && !o.autor.toLowerCase().includes(q) && !String(o.id).includes(q)) return false;
          if (est && (o.aprobacion||"pendiente").toLowerCase()!==est) return false;
          return true;
        });
        if (!items.length){container.innerHTML=`<div class="empty">Sin resultados.</div>`;return;}
        html=items.map(o=>{
          const ap=(o.aprobacion||"pendiente").toLowerCase();
          const bc=ap==="aprobado"?"badge-aprobado":ap==="suspension"?"badge-suspension":ap==="rechazado"?"badge-rechazado":"badge-pendiente";
          const cv=o.cover?`<img src="${o.cover}" class="item-cover" alt="">`:`<div class="item-cover"></div>`;
          return `<div class="item-card">${cv}
            <div class="item-info">
              <h4>${o.titulo} <span class="badge ${bc}">${ap}</span></h4>
              <small>ID: ${o.id} Â· ${o.autor} Â· ${o.capitulos} caps</small>
            </div>
            <div class="item-actions">
              <button class="btn-action approve" onclick="accion('aprobado','obra','${o.id}')">Aprobar</button>
              <button class="btn-action edit"    onclick="accion('editarObra','obra','${o.id}','${encodeURIComponent(o.titulo)}','${encodeURIComponent(o.cover||'')}','${encodeURIComponent(o.sinopsis||'')}')">Editar</button>
              <button class="btn-action danger"  onclick="accion('suspension','obra','${o.id}')">Suspender</button>
              <button class="btn-action del"     onclick="accionEliminar('obra','${o.id}','${encodeURIComponent(o.titulo)}')">Eliminar</button>
            </div>
          </div>`;
        }).join("");

      } else if (currentTab==="autores") {
        const items=allAutores.filter(a=>!q||(a.nombre||"").toLowerCase().includes(q)||String(a.id_autor).includes(q));
        if(!items.length){container.innerHTML=`<div class="empty">Sin autores.</div>`;return;}
        html=items.map(a=>{
          const est2=(a.estado||"activo").toLowerCase();
          const bc=est2==="suspendido"?"badge-suspension":"badge-activo";
          return `<div class="item-card">
            <div class="item-info">
              <h4>${a.nombre} <span class="badge ${bc}">${est2}</span></h4>
              <small>ID: ${a.id_autor} Â· ${a.email||""}</small>
            </div>
            <div class="item-actions">
              ${est2==="suspendido"
                ?`<button class="btn-action approve" onclick="accion('activar','autor','${a.id_autor}')">Activar</button>`
                :`<button class="btn-action danger"  onclick="accion('suspender','autor','${a.id_autor}')">Suspender</button>`}
              <button class="btn-action edit" onclick="accionFoto('autor','${a.id_autor}','${encodeURIComponent(a.nombre)}')">Cambiar foto</button>
            </div>
          </div>`;
        }).join("");

      } else if (currentTab==="moderadores") {
        const items=allMods.filter(m=>!q||(m.nombre||"").toLowerCase().includes(q)||String(m.id_staff).includes(q));
        if(!items.length){container.innerHTML=`<div class="empty">Sin moderadores.</div>`;return;}
        html=items.map(m=>{
          const est2=(m.estado||"activo").toLowerCase();
          const bc=est2==="suspendido"?"badge-suspension":"badge-mod";
          return `<div class="item-card">
            <div class="item-info">
              <h4>${m.nombre} <span class="badge ${bc}"> ${est2}</span></h4>
              <small>ID: ${m.id_staff} Â· ${m.email||""}</small>
            </div>
            <div class="item-actions">
              ${est2==="suspendido"
                ?`<button class="btn-action approve" onclick="accion('activar','mod','${m.id_staff}')">Activar</button>`
                :`<button class="btn-action danger"  onclick="accion('suspender','mod','${m.id_staff}')">Suspender</button>`}
              <button class="btn-action edit" onclick="accionFoto('mod','${m.id_staff}','${encodeURIComponent(m.nombre)}')">Cambiar foto</button>
            </div>
          </div>`;
        }).join("");

      } else {
        const items=allAdmins.filter(a=>!q||(a.nombre||"").toLowerCase().includes(q)||String(a.id_staff).includes(q));
        if(!items.length){container.innerHTML=`<div class="empty">Sin admins.</div>`;return;}
        html=items.map(a=>{
          const est2=(a.estado||"activo").toLowerCase();
          const bc=est2==="suspendido"?"badge-suspension":"badge-admin";
          return `<div class="item-card">
            <div class="item-info">
              <h4>${a.nombre} <span class="badge ${bc}"> ${est2}</span></h4>
              <small>ID: ${a.id_staff} Â· ${a.email||""}</small>
            </div>
            <div class="item-actions">
              ${est2==="suspendido"
                ?`<button class="btn-action approve" onclick="accion('activar','admin','${a.id_staff}')">Activar</button>`
                :`<button class="btn-action danger"  onclick="accion('suspender','admin','${a.id_staff}')">Suspender</button>`}
              <button class="btn-action edit" onclick="accionFoto('admin','${a.id_staff}','${encodeURIComponent(a.nombre)}')">Cambiar foto</button>
            </div>
          </div>`;
        }).join("");
      }
      container.innerHTML=html;
    }

    window.filtrar = renderTab;

    window.accion = function(tipo, targetType, targetId, ...extras) {
      pendingAction = { tipo, targetType, targetId, mode:"action", extras };
      document.getElementById("modalTitulo").textContent = tipo;
      document.getElementById("btnConfirm").className = "btn-m confirm";

      if (tipo==="editarObra") {
        const titulo   = decodeURIComponent(extras[0]||"");
        const cover    = decodeURIComponent(extras[1]||"");
        const sinopsis = decodeURIComponent(extras[2]||"");
        document.getElementById("modalBody").innerHTML = `
          <div class="field"><label>TÃ­tulo</label><input id="editTitulo" value="${titulo.replace(/"/g,'&quot;')}"></div>
          <div class="field"><label>Portada (link Drive)</label><input id="editCover" value="${cover.replace(/"/g,'&quot;')}"></div>
          <div class="field"><label>Sinopsis</label><textarea id="editSinopsis">${sinopsis}</textarea></div>
          <div class="field"><label>Estado de aprobaciÃ³n</label>
            <select id="editAprobacion">
              <option value="aprobado">Aprobado</option>
              <option value="pendiente">Pendiente</option>
              <option value="suspension">Suspendido</option>
              <option value="revision">En revisiÃ³n</option>
            </select>
          </div>`;
      } else {
        document.getElementById("modalBody").innerHTML = `
          <div class="field"><label>Motivo</label>
            <textarea id="motivoInput" placeholder="Describe el motivo de esta acciÃ³n..."></textarea>
          </div>`;
        if (tipo.startsWith("elim")) document.getElementById("btnConfirm").className = "btn-m danger-confirm";
      }
      document.getElementById("modalOverlay").classList.add("open");
    };

    window.accionEliminar = function(targetType, targetId, titulo) {
      pendingAction = { tipo:"eliminar", targetType, targetId, mode:"delete" };
      document.getElementById("modalTitulo").textContent = `Eliminar: ${decodeURIComponent(titulo)}`;
      document.getElementById("modalBody").innerHTML = `
        <p style="color:var(--accent);margin-bottom:14px;"> Esta acciÃ³n es irreversible.</p>
        <div class="field"><label>Motivo / RazÃ³n</label>
          <textarea id="motivoInput" placeholder="Â¿Por quÃ© eliminas esta obra?"></textarea>
        </div>`;
      document.getElementById("btnConfirm").className = "btn-m danger-confirm";
      document.getElementById("modalOverlay").classList.add("open");
    };

    window.accionFoto = function(targetType, targetId, nombre) {
      pendingAction = { modo:"foto", targetType, targetId };
      document.getElementById("modalTitulo").textContent = `Cambiar foto â€” ${decodeURIComponent(nombre)}`;
      document.getElementById("modalBody").innerHTML = `
        <div class="field"><label>Nuevo link de imagen (Drive)</label>
          <input type="text" id="nuevaFotoInput" placeholder="https://drive.google.com/...">
        </div>`;
      document.getElementById("btnConfirm").className = "btn-m confirm";
      document.getElementById("modalOverlay").classList.add("open");
    };

    window.abrirCrearAdmin = function() {
      pendingAction = { mode:"crearAdmin" };
      document.getElementById("modalTitulo").textContent = "Crear Administrador";
      document.getElementById("modalBody").innerHTML = `
        <div class="field"><label>Nombre</label><input type="text" id="newAdminNombre" placeholder="Nombre del admin"></div>
        <div class="field"><label>Correo (@kots-stf-adm.com)</label><input type="email" id="newAdminEmail" placeholder="nombre@kots-stf-adm.com"></div>
        <div class="field"><label>ContraseÃ±a</label><input type="password" id="newAdminPass" placeholder="ContraseÃ±a segura"></div>`;
      document.getElementById("btnConfirm").className = "btn-m confirm";
      document.getElementById("modalOverlay").classList.add("open");
    };

    window.cerrarModal = () => {
      document.getElementById("modalOverlay").classList.remove("open");
      pendingAction = null;
    };

    window.confirmar = async () => {
      if (!pendingAction) return;
      const pa = pendingAction;

      try {
        if (pa.mode === "crearAdmin") {
          const nombre = document.getElementById("newAdminNombre")?.value.trim();
          const email  = document.getElementById("newAdminEmail")?.value.trim();
          const pass   = document.getElementById("newAdminPass")?.value.trim();
          if (!nombre||!email||!pass) { alert("Completa todos los campos."); return; }
          if (!email.endsWith("@kots-stf-adm.com")) { alert("Correo debe terminar en @kots-stf-adm.com"); return; }
          await fetch(SCRIPT_URL, { method:"POST", mode:"no-cors",
            body: JSON.stringify({ action:"crearStaff", rol:"admin", nombre, email, pass, idOwner: ownerId }),
          });

        } else if (pa.modo === "foto") {
          const val = document.getElementById("nuevaFotoInput")?.value.trim();
          if (!val) { alert("Ingresa un link."); return; }
          const match = val.match(/[-\w]{25,}/);
          const url   = match ? `https://wsrv.nl/?url=${encodeURIComponent(`https://drive.google.com/uc?export=view&id=${match[0]}`)}&w=300&output=webp` : val;
          await fetch(SCRIPT_URL, { method:"POST", mode:"no-cors",
            body: JSON.stringify({ action:"cambiarFotoPersona", targetType: pa.targetType, targetId: pa.targetId, foto: url, idOwner: ownerId }),
          });

        } else if (pa.tipo === "editarObra") {
          const titulo     = document.getElementById("editTitulo")?.value.trim();
          const cover      = document.getElementById("editCover")?.value.trim();
          const sinopsis   = document.getElementById("editSinopsis")?.value.trim();
          const aprobacion = document.getElementById("editAprobacion")?.value;
          await fetch(SCRIPT_URL, { method:"POST", mode:"no-cors",
            body: JSON.stringify({ action:"editarObraOwner", idOwner: ownerId, idObra: pa.targetId, titulo, cover, sinopsis, aprobacion }),
          });

        } else {
          const motivo = document.getElementById("motivoInput")?.value.trim();
          if (!motivo) { alert("Ingresa un motivo."); return; }
          const actionName = pa.tipo === "eliminar" ? "eliminarObra" :
                             pa.targetType === "obra" ? "cambiarAprobacionObra" : "cambiarEstadoPersona";
          await fetch(SCRIPT_URL, { method:"POST", mode:"no-cors",
            body: JSON.stringify({
              action: actionName, idOwner: ownerId,
              targetType: pa.targetType, targetId: pa.targetId,
              nuevoEstado: pa.tipo, motivo,
            }),
          });
        }

        cerrarModal();
        setTimeout(() => cargar(), 1200);
      } catch(e) {
        alert("Error de conexiÃ³n: " + e.message);
      }
    };

    cargar();
  </script>
</body>
</html>
